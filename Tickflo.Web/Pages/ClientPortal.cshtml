@page "/portal/{token}"
@model Tickflo.Web.Pages.ClientPortalModel
@{
    ViewData["Title"] = $"{Model.Contact?.Name ?? "Client"} - Support Portal";
}

<section class="relative overflow-hidden p-6 flex-1 space-y-6 text-slate-100 rounded-3xl bg-gradient-to-br from-[#0c1220] via-[#0b101b] to-[#0a0f18]">

<div class="space-y-6">
<!-- Header Card -->
<div class="card bg-neutral-900/70 backdrop-blur rounded-2xl border border-white/5">
  <div class="card-body p-4">
    <div class="flex items-center gap-3 mb-2">
      <i class="fa fa-lock text-primary"></i>
      <span class="text-xs font-semibold text-slate-400 uppercase tracking-wide">Client Portal</span>
    </div>
    <div>
      <h1 class="text-3xl font-bold mb-1">Welcome, @Model.Contact?.Name</h1>
      <p class="text-sm text-slate-400">@Model.Workspace?.Name</p>
    </div>
  </div>
</div>

@if (Model.SelectedTicket != null)
{
  <!-- Ticket Details View -->
  <div class="card bg-neutral-900/70 backdrop-blur rounded-2xl border border-white/5">
    <div class="card-body p-4">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold flex items-center gap-2">
          <i class="fa fa-ticket"></i>
          Ticket #@Model.SelectedTicket.Id
        </h2>
        <a href="/portal/@Model.AccessToken" class="btn btn-ghost btn-sm btn-circle">
          <i class="fa fa-times"></i>
        </a>
      </div>

      <!-- Ticket Status Info -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 pb-6 border-b border-white/10">
        <div>
          <div class="text-xs text-slate-400 font-semibold">Status</div>
          @if (!string.IsNullOrEmpty(Model.SelectedTicket.Status) && Model.StatusColorByName.ContainsKey(Model.SelectedTicket.Status))
          {
            <span class="badge badge-sm rounded-full mt-2" style="background-color: @Model.StatusColorByName[Model.SelectedTicket.Status]20; color: @Model.StatusColorByName[Model.SelectedTicket.Status]">
              @Model.SelectedTicket.Status
            </span>
          }
        </div>
        <div>
          <div class="text-xs text-slate-400 font-semibold">Priority</div>
          @if (!string.IsNullOrEmpty(Model.SelectedTicket.Priority) && Model.PriorityColorByName.ContainsKey(Model.SelectedTicket.Priority))
          {
            <span class="badge badge-sm rounded-full mt-2" style="background-color: @Model.PriorityColorByName[Model.SelectedTicket.Priority]20; color: @Model.PriorityColorByName[Model.SelectedTicket.Priority]">
              @Model.SelectedTicket.Priority
            </span>
          }
        </div>
        <div>
          <div class="text-xs text-slate-400 font-semibold">Type</div>
          <div class="text-sm mt-2">@Model.SelectedTicket.Type</div>
        </div>
        <div>
          <div class="text-xs text-slate-400 font-semibold">Created</div>
          <div class="text-sm mt-2">@Model.SelectedTicket.CreatedAt.ToString("MMM dd, yyyy")</div>
        </div>
      </div>

      <!-- Editable Ticket Form -->
      @{
        bool isTicketClosed = !string.IsNullOrEmpty(Model.SelectedTicket.Status) && Model.SelectedTicket.Status.Equals("Closed", StringComparison.OrdinalIgnoreCase);
      }
      <form method="post" class="space-y-4">
        <input type="hidden" name="SelectedTicketId" value="@Model.SelectedTicket.Id" />
        <input type="hidden" name="action" value="@(isTicketClosed ? "viewTicket" : "updateTicket")" />

        <!-- Subject Field -->
        <div>
          <label class="label">
            <span class="label-text text-slate-300 font-medium text-xs">Subject</span>
            @if (!isTicketClosed)
            {
              <span class="label-text-alt text-error">*</span>
            }
          </label>
          <input
            type="text"
            name="Subject"
            value="@Model.Subject"
            placeholder="Brief title..."
            class="input input-bordered input-sm w-full bg-neutral-900/50 border-neutral-700 text-white placeholder-slate-600"
            disabled="@isTicketClosed"
            required="@(!isTicketClosed)" />
          @if (ModelState["Subject"]?.Errors.Any() == true)
          {
            <span class="text-error text-xs mt-1 block">
              @ModelState["Subject"]?.Errors.FirstOrDefault()?.ErrorMessage
            </span>
          }
        </div>

        <!-- Priority and Type Fields -->
        <div class="grid grid-cols-2 gap-4">
          <!-- Priority Dropdown -->
          <div>
            <label class="label">
              <span class="label-text text-slate-300 font-medium text-xs">Priority</span>
            </label>
            <select
              name="Priority"
              class="select select-bordered select-sm w-full bg-neutral-900/50 border-neutral-700 text-white"
              disabled="@isTicketClosed">
              <option value="">Select priority...</option>
              @foreach (var priority in Model.Priorities.OrderBy(p => p.SortOrder))
              {
                <option value="@priority.Name" selected="@(Model.Priority == priority.Name)">
                  @priority.Name
                </option>
              }
            </select>
          </div>

          <!-- Type Dropdown -->
          <div>
            <label class="label">
              <span class="label-text text-slate-300 font-medium text-xs">Type</span>
            </label>
            <select
              name="TicketType"
              class="select select-bordered select-sm w-full bg-neutral-900/50 border-neutral-700 text-white"
              disabled="@isTicketClosed">
              <option value="">Select type...</option>
              @foreach (var type in Model.Types.OrderBy(t => t.SortOrder))
              {
                <option value="@type.Name" selected="@(Model.TicketType == type.Name)">
                  @type.Name
                </option>
              }
            </select>
          </div>
        </div>

        <!-- Description Field -->
        <div>
          <label class="label">
            <span class="label-text text-slate-300 font-medium text-xs">Description</span>
            @if (!isTicketClosed)
            {
              <span class="label-text-alt text-error">*</span>
            }
          </label>
          <textarea
            name="Description"
            placeholder="Describe your issue or request..."
            rows="4"
            class="textarea textarea-bordered textarea-sm w-full bg-neutral-900/50 border-neutral-700 text-white placeholder-slate-600"
            disabled="@isTicketClosed"
            required="@(!isTicketClosed)">@Model.Description</textarea>
          @if (ModelState["Description"]?.Errors.Any() == true)
          {
            <span class="text-error text-xs mt-1 block">
              @ModelState["Description"]?.Errors.FirstOrDefault()?.ErrorMessage
            </span>
          }
        </div>

        <!-- Action Buttons -->
        @if (!isTicketClosed)
        {
          <div class="flex items-center justify-between pt-4">
            <div class="text-xs text-slate-400">
              <i class="fa fa-edit mr-1"></i>
              This ticket is open and can be edited
            </div>
            <button
              type="submit"
              class="btn btn-primary btn-sm rounded-full gap-2">
              <i class="fa fa-save"></i>
              Save Changes
            </button>
          </div>
        }
        else
        {
          <div class="alert alert-info">
            <i class="fa fa-lock"></i>
            <span>This ticket is closed and cannot be edited</span>
          </div>
        }
      </form>
    </div>
  </div>

  <!-- Comments Section -->
  <div class="card bg-neutral-900/70 backdrop-blur rounded-2xl border border-white/5">
    <div class="card-body p-4">
      <h2 class="text-xl font-bold flex items-center gap-2 mb-4">
        <i class="fa fa-comments"></i>
        Comments
      </h2>

      <!-- Comments List -->
      @if (Model.TicketComments.Any())
      {
        <div class="space-y-2 mb-6 pb-6 border-b border-white/10">
          @{
            int commentIndex = 0;
          }
          @foreach (var comment in Model.TicketComments.OrderBy(c => c.CreatedAt))
          {
            commentIndex++;
            bool isClientComment = comment.CreatedByContactId.HasValue;
            string commentAuthor = isClientComment 
              ? (string.IsNullOrWhiteSpace(Model.Contact?.Name) ? "Portal Client" : Model.Contact!.Name) 
              : "Support Team";
            
            // Alternate styling for visual distinction between consecutive comments
            // Odd comments (1, 3, 5...) use darker bg with primary colors
            // Even comments (2, 4, 6...) use slightly lighter bg with accent colors
            string containerBg = commentIndex % 2 == 1 ? "bg-neutral-900/50" : "bg-neutral-800/50";
            string borderColor = commentIndex % 2 == 1 ? "border-white/10" : "border-white/5";
            string avatarBg = commentIndex % 2 == 1 ? "bg-primary/20" : "bg-accent/20";
            string avatarText = commentIndex % 2 == 1 ? "text-primary" : "text-accent";
            
            <div class="mb-3 p-4 rounded-lg @containerBg border @borderColor backdrop-blur-sm transition-all hover:border-white/20">
              <div class="flex items-start gap-3">
                <!-- Avatar -->
                <div class="avatar placeholder flex-shrink-0">
                  <div class="w-10 h-10 rounded-full @avatarBg @avatarText flex items-center justify-center font-bold text-sm relative">
                    @if (isClientComment)
                    {
                      <img src="/contacts/@comment.CreatedByContactId/avatar" alt="@commentAuthor" 
                           class="w-10 h-10 rounded-full object-cover" 
                           onload="if(this.complete) this.style.opacity='1';" 
                           onerror="this.style.display='none';" />
                    }
                    <span class="absolute">@(commentAuthor.First().ToString().ToUpper())</span>
                  </div>
                </div>
                
                <!-- Message Content -->
                <div class="flex-1 min-w-0">
                  <!-- Header -->
                  <div class="flex items-center flex-wrap gap-2 mb-2">
                    <span class="font-semibold text-white">@commentAuthor</span>
                    @if (isClientComment)
                    {
                      <span class="badge badge-sm badge-outline badge-primary">
                        <i class="fa fa-shield-alt mr-1 text-xs"></i>Client
                      </span>
                    }
                    <time class="text-xs text-white/50 ml-auto">@comment.CreatedAt.ToLocalTime().ToString("MMM dd, h:mm tt")</time>
                  </div>
                  
                  <!-- Message Text -->
                  <div class="text-sm text-white/90 leading-relaxed break-words max-w-2xl">
                    @comment.Content
                  </div>
                  
                  <!-- Footer -->
                  @if (comment.UpdatedAt.HasValue)
                  {
                    <div class="text-xs text-white/40 mt-2">
                      <i class="fa fa-pen-square mr-1"></i>Edited @comment.UpdatedAt.Value.ToString("MMM dd")
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      }
      else
      {
        <div class="text-center py-8 text-slate-400">
          <i class="fa fa-comments text-2xl mb-3 block opacity-50"></i>
          <p>No comments yet. Start a conversation!</p>
        </div>
      }

      <!-- Add Comment Form -->
      <form method="post" class="space-y-3">
        <input type="hidden" name="SelectedTicketId" value="@Model.SelectedTicket.Id" />
        <input type="hidden" name="action" value="addComment" />

        <div>
          <label class="label">
            <span class="label-text text-slate-300 font-medium text-xs">Add Comment</span>
          </label>
          <textarea
            name="NewCommentContent"
            placeholder="Share your thoughts or provide additional information..."
            rows="3"
            class="textarea textarea-bordered textarea-sm w-full bg-neutral-900/50 border-neutral-700 text-white placeholder-slate-600"></textarea>
          @if (ModelState["NewCommentContent"]?.Errors.Any() == true)
          {
            <span class="text-error text-xs mt-1 block">
              @ModelState["NewCommentContent"]?.Errors.FirstOrDefault()?.ErrorMessage
            </span>
          }
        </div>

        <div class="flex items-center justify-between">
          <div class="text-xs text-slate-400">
            <i class="fa fa-info-circle mr-1"></i>
            Your comment is visible to the support team
          </div>
          <button
            type="submit"
            class="btn btn-primary btn-sm rounded-full gap-2">
            <i class="fa fa-send"></i>
            Post Comment
          </button>
        </div>
      </form>
    </div>
  </div>
}
else
{
  <!-- Create Ticket Card -->
  <div class="card bg-neutral-900/70 backdrop-blur rounded-2xl border border-white/5">
    <div class="card-body p-4">
      <h2 class="text-xl font-bold flex items-center gap-2 mb-4">
        <i class="fa fa-plus"></i>
        Create New Ticket
      </h2>

      <form method="post" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Subject Field -->
        <div class="lg:col-span-2">
          <label class="label">
            <span class="label-text text-slate-300 font-medium text-xs">Subject</span>
            <span class="label-text-alt text-error">*</span>
          </label>
          <input
            type="text"
            name="Subject"
            value="@Model.Subject"
            placeholder="Brief title..."
            class="input input-bordered input-sm w-full bg-neutral-900/50 border-neutral-700 text-white placeholder-slate-600"
            required />
          @if (ModelState["Subject"]?.Errors.Any() == true)
          {
            <span class="text-error text-xs mt-1 block">
              @ModelState["Subject"]?.Errors.FirstOrDefault()?.ErrorMessage
            </span>
          }
        </div>

        <!-- Priority Dropdown -->
        <div>
          <label class="label">
            <span class="label-text text-slate-300 font-medium text-xs">Priority</span>
          </label>
          <select
            name="Priority"
            class="select select-bordered select-sm w-full bg-neutral-900/50 border-neutral-700 text-white">
            <option value="">Select priority...</option>
            @foreach (var priority in Model.Priorities.OrderBy(p => p.SortOrder))
            {
              <option value="@priority.Name" selected="@(Model.Priority == priority.Name)">
                @priority.Name
              </option>
            }
          </select>
        </div>

        <!-- Type Dropdown -->
        <div>
          <label class="label">
            <span class="label-text text-slate-300 font-medium text-xs">Type</span>
          </label>
          <select
            name="TicketType"
            class="select select-bordered select-sm w-full bg-neutral-900/50 border-neutral-700 text-white">
            <option value="">Select type...</option>
            @foreach (var type in Model.Types.OrderBy(t => t.SortOrder))
            {
              <option value="@type.Name" selected="@(Model.TicketType == type.Name)">
                @type.Name
              </option>
            }
          </select>
        </div>

        <!-- Description Field -->
        <div class="md:col-span-2 lg:col-span-4">
          <label class="label">
            <span class="label-text text-slate-300 font-medium text-xs">Description</span>
            <span class="label-text-alt text-error">*</span>
          </label>
          <textarea
            name="Description"
            placeholder="Describe your issue or request..."
            rows="3"
            class="textarea textarea-bordered textarea-sm w-full bg-neutral-900/50 border-neutral-700 text-white placeholder-slate-600"
            required>@Model.Description</textarea>
          @if (ModelState["Description"]?.Errors.Any() == true)
          {
            <span class="text-error text-xs mt-1 block">
              @ModelState["Description"]?.Errors.FirstOrDefault()?.ErrorMessage
            </span>
          }
        </div>

        <!-- Submit Button -->
        <div class="md:col-span-2 lg:col-span-4 flex items-center justify-between">
          <div class="text-xs text-slate-400">
            <i class="fa fa-info-circle mr-1"></i>
            Only you and the support team can see your tickets
          </div>
          <button
            type="submit"
            class="btn btn-primary btn-sm rounded-full gap-2">
            <i class="fa fa-send"></i>
            Submit Ticket
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tickets List Card -->
  <div class="card bg-neutral-900/70 backdrop-blur rounded-2xl border border-white/5">
    <div class="card-body p-4">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold flex items-center gap-2">
          <i class="fa fa-ticket"></i>
          Your Tickets
        </h2>
        <span class="badge badge-primary rounded-full">@Model.Tickets.Count</span>
      </div>

      @if (Model.Tickets.Any())
      {
        <div class="overflow-x-auto rounded-2xl bg-neutral-900/70 backdrop-blur">
          <table class="table table-sm table-zebra">
            <thead class="bg-white/5">
              <tr>
                <th>ID</th>
                <th>Subject</th>
                <th class="text-center">Priority</th>
                <th class="text-center">Status</th>
                <th class="text-right">Created</th>
                <th class="text-center">Action</th>
              </tr>
            </thead>
            <tbody>
              @foreach (var ticket in Model.Tickets.OrderByDescending(t => t.CreatedAt))
              {
                <tr class="hover">
                  <td class="font-mono text-sm text-slate-400">
                    #@ticket.Id
                  </td>
                  <td class="font-medium">
                    @ticket.Subject
                  </td>
                  <td class="text-center">
                    @if (!string.IsNullOrEmpty(ticket.Priority) && Model.PriorityColorByName.ContainsKey(ticket.Priority))
                    {
                      <span class="badge badge-sm rounded-full" style="background-color: @Model.PriorityColorByName[ticket.Priority]20; color: @Model.PriorityColorByName[ticket.Priority]">
                        @ticket.Priority
                      </span>
                    }
                  </td>
                  <td class="text-center">
                    @if (!string.IsNullOrEmpty(ticket.Status) && Model.StatusColorByName.ContainsKey(ticket.Status))
                    {
                      <span class="badge badge-sm rounded-full" style="background-color: @Model.StatusColorByName[ticket.Status]20; color: @Model.StatusColorByName[ticket.Status]">
                        @ticket.Status
                      </span>
                    }
                  </td>
                  <td class="text-right text-sm text-slate-400">
                    @ticket.CreatedAt.ToString("MMM dd, yyyy")
                  </td>
                  <td class="text-center">
                    <a href="/portal/@Model.AccessToken?handler=ViewTicket&ticketId=@ticket.Id" class="btn btn-xs btn-ghost gap-2">
                      <i class="fa fa-eye"></i>
                      View
                    </a>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
      else
      {
        <div class="text-center py-12 text-slate-400">
          <i class="fa fa-inbox text-4xl mb-3 block opacity-50"></i>
          <p>No tickets yet. Create your first ticket above!</p>
        </div>
      }
    </div>
  </div>
}
