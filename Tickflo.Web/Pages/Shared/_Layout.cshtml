@inject Tickflo.Core.Data.INotificationRepository NotificationRepository
@inject Tickflo.Core.Services.Common.ICurrentUserService CurrentUserService

@{
    var theme = Context.Request.Cookies["theme"] ?? "dark";
    var path = Context.Request.Path.Value ?? "";
    var isAuthenticated = Context.User?.Identity?.IsAuthenticated == true;

    const string lastWorkspaceCookieName = "last_workspace_slug";
    var lastWorkspaceSlug = Context.Request.Cookies[lastWorkspaceCookieName];
    string? currentWorkspaceSlug = null;

    string logoHref = "/";
    int unreadNotificationCount = 0;

    if (isAuthenticated)
    {
        // Try to extract workspace slug from URL pattern: /workspaces/{slug}/...
        if (path.Contains("/workspaces/"))
        {
            var parts = path.Split(new[] { "/workspaces/" }, StringSplitOptions.None);
            if (parts.Length > 1)
            {
                var slugPart = parts[1];
                var slug = slugPart.Split('/')[0]; // Get the slug before the next slash
                if (!string.IsNullOrEmpty(slug))
                {
                    currentWorkspaceSlug = slug;
                }
            }
        }

        // Prefer the slug from the current path, then fall back to the remembered workspace
        var targetSlug = !string.IsNullOrEmpty(currentWorkspaceSlug)
            ? currentWorkspaceSlug
            : (!string.IsNullOrEmpty(lastWorkspaceSlug) ? lastWorkspaceSlug : null);

        logoHref = !string.IsNullOrEmpty(targetSlug) ? $"/workspaces/{targetSlug}" : "/workspaces";

        // Refresh the last-workspace cookie whenever we are on a workspace route
        if (!string.IsNullOrEmpty(currentWorkspaceSlug))
        {
            var cookieOptions = new Microsoft.AspNetCore.Http.CookieOptions
            {
                Path = "/",
                HttpOnly = true,
                Secure = Context.Request.IsHttps,
                SameSite = Microsoft.AspNetCore.Http.SameSiteMode.Lax,
                Expires = DateTimeOffset.UtcNow.AddDays(30),
                IsEssential = true
            };

            Context.Response.Cookies.Append(lastWorkspaceCookieName, currentWorkspaceSlug, cookieOptions);
        }

        // Get unread notification count
        if (CurrentUserService.TryGetUserId(User, out var userId))
        {
            unreadNotificationCount = await NotificationRepository.CountUnreadForUserAsync(userId);
        }
    }
}

<!DOCTYPE html>
<html lang="en" data-theme="@theme">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Tickflo</title>
    <link rel="icon" href="~/img/icon.png" />
    <link rel="stylesheet" href="~/css/dist.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/lib/font-awesome/css/fontawesome.min.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/lib/font-awesome/css/all.min.css" asp-append-version="true" />
</head>

<body data-theme="@theme" class="shell-outer">
    <mini-profiler />
    @if (Context.Request.Path.Value?.ToLower() == "/login")
    {
        <header class="navbar glass-panel shadow-xl rounded-3xl sticky top-4 max-w-6xl mx-auto px-4 md:px-6">
            <div class="w-full flex items-center gap-4">
                <div class="flex-1">
                    <a href="@logoHref" class="flex items-center gap-3">
                        <img src="~/img/logo.png" alt="Tickflo" class="h-8" />
                    </a>
                </div>
            </div>
        </header>
    }
    else
    {
        <header class="navbar glass-panel shadow-xl rounded-3xl sticky top-4 max-w-7xl mx-auto px-4 md:px-6">
            <div class="w-full flex items-center gap-4">
                <div class="flex-1 flex items-center gap-3">
                    <a href="@logoHref" class="flex items-center gap-3">
                        <img src="~/img/logo.png" alt="Tickflo" class="h-8" />
                    </a>
                </div>
                <div class="flex-none flex items-center gap-2">
                    <a href="/workspaces" class="btn btn-soft btn-sm rounded-full gap-2">
                        <i class="fa fa-layer-group"></i>
                        Workspaces
                    </a>
                    <a href="/notifications" class="btn btn-soft btn-sm rounded-full gap-2 relative">
                        <i class="fa fa-bell"></i>
                        @if (unreadNotificationCount > 0)
                        {
                            <span class="badge badge-xs badge-primary rounded-full absolute -top-1 -right-1">@unreadNotificationCount</span>
                        }
                    </a>
                    @await Html.PartialAsync("_UserMenu")
                </div>
            </div>
        </header>
    }

    <main class="max-w-7xl mx-auto px-4 md:px-6 lg:px-8 py-8">
        @RenderBody()
    </main>

    <script>
        function setThemeCookie(value) {
            const expires = new Date();
            expires.setFullYear(expires.getFullYear() + 1);
            document.cookie = `theme=${value}; path=/; expires=${expires.toUTCString()}`;
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"
        integrity="sha512-7rhBJh1om/W5Ztx7WiYOR9h2wlSaTmPyQMoHFtbT/FVNIA12y6S6I8HY9mrBS1uJ3dSU/R3qaSAXsGYuRjMDxg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>

</html>