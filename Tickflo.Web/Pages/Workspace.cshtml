@page "/workspaces/{slug}"
@model Tickflo.Web.Pages.WorkspaceModel
@{
    ViewData["Title"] = Model.Workspace?.Name ?? "Workspaces";
}

<div class="flex flex-row gap-4">
    @await Html.PartialAsync("_WorkspaceSidebar", Model.Workspace?.Slug ?? "")
    <section class="p-6 flex-1">
        <div role="alert" class="alert alert-info mb-4">
            <span>You have not yet confirmed your email address</span>
            <div class="join join-horizontal">
                <form class="join-item" data-discover="true" action="/email-confirmation/dismiss" method="post">
                    <button type="submit" class="btn btn-soft btn-sm">Dismiss</button>
                </form>
                <form class="join-item" data-discover="true" action="/email-confirmation/resend" method="post">
                    <button type="submit" class="btn btn-soft btn-sm btn-primary">Resend Email</button>
                </form>
            </div>
        </div>

        @if (Model.Workspace == null)
        {
            <div class="card bg-base-100 shadow-sm mb-6">
                <div class="card-body">
                    <h2 class="card-title">Dashboard</h2>
                    <p class="text-sm text-base-content/70">Overview of your account and activity</p>
                </div>
            </div>
            <div class="stats stats-horizontal bg-base-100 shadow-sm mb-6">
                <div class="stat">
                    <div class="stat-title">Revenue</div>
                    <div class="stat-value">$24,600</div>
                    <div class="stat-desc">+12% from last month</div>
                </div>
                <div class="stat">
                    <div class="stat-title">Orders</div>
                    <div class="stat-value">1,284</div>
                    <div class="stat-desc">+4% this week</div>
                </div>
                <div class="stat">
                    <div class="stat-title">Customers</div>
                    <div class="stat-value">3,721</div>
                    <div class="stat-desc">+156 new</div>
                </div>
                <div class="stat">
                    <div class="stat-title">Conversion</div>
                    <div class="stat-value">3.7%</div>
                    <div class="stat-desc">-0.2% this week</div>
                </div>
            </div>
        }
        else
        {
            <div class="flex flex-col gap-8">
                <div class="mb-2">
                    <h1 class="text-3xl font-bold tracking-tight mb-1">Dashboard</h1>
                    <div class="text-base-content/60 flex items-center gap-2 flex-wrap">
                        <span>Workspace: <span class="font-semibold">@Model.Workspace.Name</span></span>
                        <span class="badge badge-outline">@Model.Workspace.Slug</span>
                        @if (Model.CanViewTickets)
                        {
                            var scopeLabel = string.IsNullOrWhiteSpace(Model.TicketViewScope) ? "ALL" : Model.TicketViewScope.ToUpperInvariant();
                            <span class="badge badge-soft">Scope: @scopeLabel</span>
                        }
                    </div>
                </div>
                <!-- Stat Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                    @if (Model.CanViewTickets)
                    {
                        <a href="/workspaces/@Model.Workspace.Slug/tickets?status=Open&range=@Model.RangeDays" style="text-decoration:none">
                            <div class="card bg-primary text-primary-content shadow-xl cursor-pointer hover:shadow-2xl transition-shadow">
                                <div class="card-body">
                                    <div class="flex items-center gap-3">
                                        <i class="fa fa-ticket-alt fa-2x"></i>
                                        <div>
                                            <div class="text-lg font-bold">Open Tickets</div>
                                            <div class="text-3xl font-extrabold">@Model.OpenTickets</div>
                                            <div class="text-xs opacity-80">of @Model.TotalTickets total</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                    }
                    @if (Model.CanViewTickets)
                    {
                        <a href="/workspaces/@Model.Workspace.Slug/tickets?status=Closed&range=@Model.RangeDays" style="text-decoration:none">
                            <div class="card bg-success text-success-content shadow-xl cursor-pointer hover:shadow-2xl transition-shadow">
                                <div class="card-body">
                                    <div class="flex items-center gap-3">
                                        <i class="fa fa-check-circle fa-2x"></i>
                                        <div>
                                            <div class="text-lg font-bold">Resolved</div>
                                            <div class="text-3xl font-extrabold">@Model.ResolvedTickets</div>
                                            <div class="text-xs opacity-80">last @Model.RangeDays days</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                    }
                    <div class="card bg-info text-info-content shadow-xl">
                        <div class="card-body">
                            <div class="flex items-center gap-3">
                                <i class="fa fa-users fa-2x"></i>
                                <div>
                                    <div class="text-lg font-bold">Active Members</div>
                                    <div class="text-3xl font-extrabold">@Model.ActiveMembers</div>
                                    <div class="text-xs opacity-80">accepted</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    @if (Model.CanViewTickets)
                    {
                    <div class="card bg-warning text-warning-content shadow-xl">
                        <div class="card-body">
                            <div class="flex items-center gap-3">
                                <i class="fa fa-clock fa-2x"></i>
                                <div>
                                    <div class="text-lg font-bold">Avg Resolution</div>
                                    <div class="text-3xl font-extrabold">@Model.AvgResolutionLabel</div>
                                    <div class="text-xs opacity-80">closed in last @Model.RangeDays days</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    }
                    @if (Model.CanViewTickets)
                    {
                    <div class="card bg-base-200 text-base-content shadow-xl">
                        <div class="card-body">
                            <div class="flex items-center gap-3">
                                <i class="fa fa-layer-group fa-2x text-info"></i>
                                <div>
                                    <div class="text-lg font-bold">Status</div>
                                    <div class="flex flex-col gap-1">
                                        @foreach (var s in Model.StatusList.OrderBy(x => x.SortOrder))
                                        {
                                            var count = Model.RecentTickets.Count(t => t.Status == s.Name);
                                            var sColor = string.IsNullOrWhiteSpace(s.Color) ? "neutral" : s.Color;
                                            var sIsHex = sColor.StartsWith("#");
                                            var sCls = sIsHex ? "badge badge-outline" : $"badge badge-outline badge-{sColor}";
                                            var sStyle = sIsHex ? $"--badge-color: {sColor};" : null;
                                            <div class="flex items-center gap-2">
                                                <a href="/workspaces/@Model.Workspace.Slug/tickets?status=@Uri.EscapeDataString(s.Name)&range=@Model.RangeDays" class="@sCls" style="@sStyle">@s.Name</a>
                                                <span class="font-bold">@count</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    }
                    @if (Model.CanViewTickets)
                    {
                    <div class="card bg-base-200 text-base-content shadow-xl">
                        <div class="card-body">
                            <div class="flex items-center gap-3">
                                <i class="fa fa-flag fa-2x text-error"></i>
                                <div>
                                    <div class="text-lg font-bold">Priority</div>
                                    <div class="flex flex-col gap-1">
                                        @foreach (var p in Model.PriorityCounts.OrderByDescending(x => x.Value))
                                        {
                                            var prio = Model.PriorityList.FirstOrDefault(x => x.Name == p.Key);
                                            var pColor = string.IsNullOrWhiteSpace(prio?.Color) ? "neutral" : prio!.Color;
                                            var pIsHex = pColor.StartsWith("#");
                                            var pCls = pIsHex ? "badge badge-outline" : $"badge badge-outline badge-{pColor}";
                                            var pStyle = pIsHex ? $"--badge-color: {pColor};" : null;
                                            <div class="flex items-center gap-2">
                                                <a href="/workspaces/@Model.Workspace.Slug/tickets?priority=@Uri.EscapeDataString(p.Key)&range=@Model.RangeDays" class="@pCls" style="@pStyle">@p.Key</a>
                                                <span class="font-bold">@p.Value</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    }
                </div>
                <!-- Main Content Grid -->
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                    <!-- Recent Tickets Table -->
                    @if (Model.CanViewTickets)
                    {
                    <div class="xl:col-span-2">
                        <div class="card bg-base-100 shadow-xl">
                            <div class="card-body">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="text-lg font-bold">Recent Tickets</div>
                                    <form method="get" class="flex gap-2 items-center" onsubmit="return true;">
                                        <select name="range" class="select select-bordered select-sm" onchange="this.form.submit()">
                                            <option value="7" selected="@(Model.RangeDays == 7 ? "selected" : null)">Last 7 days</option>
                                            <option value="30" selected="@(Model.RangeDays == 30 ? "selected" : null)">Last 30 days</option>
                                            <option value="90" selected="@(Model.RangeDays == 90 ? "selected" : null)">Last 90 days</option>
                                        </select>
                                        <select name="assignment" class="select select-bordered select-sm" onchange="this.form.submit()">
                                            <option value="all" selected="@(Model.AssignmentFilter == "all" ? "selected" : null)">All</option>
                                            <option value="unassigned" selected="@(Model.AssignmentFilter == "unassigned" ? "selected" : null)">Unassigned</option>
                                            <option value="me" selected="@(Model.AssignmentFilter == "me" ? "selected" : null)">Assigned to Me</option>
                                            <option value="others" selected="@(Model.AssignmentFilter == "others" ? "selected" : null)">Assigned to Others</option>
                                            @if (Model.WorkspaceMembers != null && Model.WorkspaceMembers.Count > 0)
                                            {
                                                <optgroup label="Members">
                                                @foreach (var m in Model.WorkspaceMembers.OrderBy(x => x.Name))
                                                {
                                                    <option value="user-@m.Id" selected="@(Model.AssignmentFilter == $"user-{m.Id}" ? "selected" : null)">@m.Name</option>
                                                }
                                                </optgroup>
                                            }
                                            @if (Model.WorkspaceTeams != null && Model.WorkspaceTeams.Count > 0)
                                            {
                                                <optgroup label="Teams">
                                                @foreach (var t in Model.WorkspaceTeams.OrderBy(x => x.Name))
                                                {
                                                    <option value="team-@t.Id" selected="@(Model.AssignmentFilter == $"team-{t.Id}" ? "selected" : null)">@t.Name</option>
                                                }
                                                </optgroup>
                                            }
                                        </select>
                                    </form>
                                </div>
                                <div class="overflow-x-auto rounded-box">
                                    <table class="table table-zebra table-md">
                                        <thead>
                                            <tr>
                                                <th>Ticket</th>
                                                <th>Type</th>
                                                <th>Status</th>
                                                <th>Assignee</th>
                                                <th>Updated</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        @foreach (var t in Model.RecentTickets)
                                        {
                                            <tr>
                                                <td><a class="link link-hover font-medium" href="/workspaces/@Model.Workspace!.Slug/tickets/@t.Id?range=@Model.RangeDays">#@t.Id @t.Subject</a></td>
                                                <td>
                                                    @{ var typeColor = string.IsNullOrWhiteSpace(t.TypeColor) ? "neutral" : t.TypeColor; var typeIsHex = typeColor.StartsWith("#"); var typeCls = typeIsHex ? "badge badge-outline badge-lg" : $"badge badge-outline badge-lg badge-{typeColor}"; var typeStyle = typeIsHex ? $"--badge-color: {typeColor};" : null; }
                                                    <a class="@typeCls" style="@typeStyle" href="/workspaces/@Model.Workspace!.Slug/tickets?type=@Uri.EscapeDataString(t.Type)&range=@Model.RangeDays">@t.Type</a>
                                                </td>
                                                <td>
                                                    @{ var statusColor = string.IsNullOrWhiteSpace(t.StatusColor) ? "neutral" : t.StatusColor; var sIsHex2 = statusColor.StartsWith("#"); var statusCls = sIsHex2 ? "badge badge-outline badge-lg" : $"badge badge-outline badge-lg badge-{statusColor}"; var statusStyle2 = sIsHex2 ? $"--badge-color: {statusColor};" : null; }
                                                    <a class="@statusCls" style="@statusStyle2" href="/workspaces/@Model.Workspace!.Slug/tickets?status=@Uri.EscapeDataString(t.Status)&range=@Model.RangeDays">@t.Status</a>
                                                </td>
                                                <td>
                                                    @if (!string.IsNullOrWhiteSpace(t.AssigneeName)) {
                                                        <div class="flex items-center gap-2">
                                                            <div class="avatar placeholder">
                                                                <div class="w-8 rounded-full bg-neutral text-neutral-content">@t.AssigneeName.Substring(0,1)</div>
                                                            </div>
                                                            <span class="font-medium">@t.AssigneeName</span>
                                                        </div>
                                                    } else {
                                                        <span class="opacity-50">—</span>
                                                    }
                                                </td>
                                                <td>@t.UpdatedAt.ToLocalTime().ToString("MMM dd, HH:mm")</td>
                                                <td>
                                                    <a class="btn btn-sm btn-soft" href="/workspaces/@Model.Workspace!.Slug/tickets/@t.Id?range=@Model.RangeDays">View</a>
                                                </td>
                                            </tr>
                                        }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    }
                    <!-- Top Members Card -->
                    @if (Model.CanViewTickets)
                    {
                    <div>
                        <div class="card bg-base-100 shadow-xl">
                            <div class="card-body">
                                <div class="text-lg font-bold mb-4">Top Members</div>
                                <ul class="space-y-4">
                                @foreach (var m in Model.TopMembers)
                                {
                                    <li class="flex items-center gap-4 p-2 rounded-lg hover:bg-base-200 transition">
                                        <div class="avatar placeholder">
                                            <div class="w-12 rounded-full bg-primary text-primary-content">@m.Name.Substring(0,1)</div>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-semibold">@m.Name</div>
                                            <div class="text-xs text-base-content/60">@m.ResolvedCount tickets resolved</div>
                                        </div>
                                        <span class="badge badge-outline">Member</span>
                                    </li>
                                }
                                </ul>
                            </div>
                        </div>
                    </div>
                    }
                </div>
            </div>
        }
    </section>
</div>
