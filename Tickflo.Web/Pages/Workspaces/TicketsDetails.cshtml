@page "/workspaces/{slug}/tickets/{id:int}"
@model Tickflo.Web.Pages.Workspaces.TicketsDetailsModel
@{
    ViewData["Title"] = "Ticket Details";
}

<div class="flex flex-row gap-4">
  @await Html.PartialAsync("_WorkspaceSidebar", Model.WorkspaceSlug)
  <section class="p-6 flex-1">
@{
  var sectionTitle = (Model.Ticket == null || Model.Ticket.Id == 0) ? "New Ticket" : "Ticket Details";
}
@await Html.PartialAsync("_WorkspaceHeader", new Tickflo.Web.Pages.Shared.WorkspaceHeaderView { Slug = Model.WorkspaceSlug, Name = Model.Workspace?.Name ?? "Workspace", SectionTitle = sectionTitle })

<div class="grid gap-4">
  <div class="flex items-center justify-between">
    <div class="join">
      @{
      }
      <a class="btn btn-soft join-item btn-sm md:btn-md" asp-page="/Workspaces/Tickets" asp-route-slug="@Model.WorkspaceSlug" asp-preserve-query>Back to list</a>
    </div>
  </div>

  <div class="card bg-base-100">
    <div class="card-body gap-2">
      <div class="flex items-center justify-between flex-wrap gap-2">
        <h2 class="card-title">@Model.Ticket?.Subject</h2>
        <div class="join">
          @{
            var pColor = (Model.Ticket != null && Model.PriorityColorByName.TryGetValue(Model.Ticket.Priority, out var pc)) ? pc : "neutral";
            var pIsHex = pColor.StartsWith("#");
            var pCls = pIsHex ? "badge badge-soft join-item" : $"badge badge-soft badge-{pColor} join-item";
            var pStyle = pIsHex ? $"background-color: {pColor}; color: #fff;" : null;
          }
          <span class="@pCls" style="@pStyle">@Model.Ticket?.Priority</span>
          @{
            var sColor = (Model.Ticket != null && Model.StatusColorByName.TryGetValue(Model.Ticket.Status, out var c)) ? c : "neutral";
            var isHex = sColor.StartsWith("#");
            var sCls = isHex ? "badge badge-soft join-item" : $"badge badge-soft badge-{sColor} join-item";
            var sStyle = isHex ? $"background-color: {sColor}; color: #fff;" : null;
          }
          <span class="@sCls" style="@sStyle">@Model.Ticket?.Status</span>
        </div>
      </div>
      <div class="text-sm opacity-70">Created @Model.Ticket?.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</div>
      @if(!string.IsNullOrWhiteSpace(Model.Ticket?.InventoryRef))
      {
        <div>Inventory: <a class="link" href="/workspaces/@Model.WorkspaceSlug/inventory?Query=@Model.Ticket!.InventoryRef">@Model.Ticket!.InventoryRef</a></div>
      }
      @if(Model.Contact != null)
      {
        <div>Contact: <span class="font-medium">@Model.Contact.Name</span> <span class="opacity-70">(@Model.Contact.Email)</span></div>
      }
      @if(Model.Ticket?.AssignedUserId != null)
      {
        <div>
          Assignee:
          <a class="link" href="/workspaces/@Model.WorkspaceSlug/tickets?AssigneeUserId=@Model.Ticket!.AssignedUserId" asp-preserve-query>View all for assignee</a>
        </div>
      }
      <div class="prose max-w-none">
        <p>@Model.Ticket?.Description</p>
      </div>
    </div>
  </div>

  @if(Model.IsWorkspaceAdmin)
  {
    <div class="card bg-base-100">
      <div class="card-body">
        <form method="post" asp-page-handler="Save" class="grid gap-3" id="ticket-save-form">
          <input type="hidden" name="slug" value="@Model.WorkspaceSlug" />
             <input type="hidden" name="id" value="@Model.Ticket?.Id ?? 0" />
          <div class="grid gap-2 md:grid-cols-2">
            <div>
              <label class="label">Contact</label>
              <input type="hidden" name="EditContactId" id="editContactId" value="@Model.Ticket!.ContactId" />
              <input id="contact-search" class="input input-bordered w-full" list="contacts-list" placeholder="Search contacts by name or email" />
              <datalist id="contacts-list">
                @foreach (var c in Model.Contacts)
                {
                  <option value="@c.Name (@c.Email)" data-id="@c.Id"></option>
                }
              </datalist>
            </div>
            <div>
              <label class="label">Subject</label>
              <input name="EditSubject" value="@Model.Ticket!.Subject" class="input input-bordered w-full" />
            </div>
            <div>
              <label class="label">Priority</label>
              <select name="EditPriority" class="select select-bordered w-full">
                @foreach (var p in Model.Priorities)
                {
                  if (Model.Ticket!.Priority == p.Name) {<option value="@p.Name" selected>@p.Name</option>} else {<option value="@p.Name">@p.Name</option>}
                }
              </select>
            </div>
          </div>
          <div>
            <label class="label">Description</label>
            <textarea name="EditDescription" class="textarea textarea-bordered w-full" rows="6">@Model.Ticket!.Description</textarea>
          </div>
          <div>
            <label class="label">Status</label>
            <select name="EditStatus" class="select select-bordered w-full">
              @foreach (var s in Model.Statuses)
              {
                if (Model.Ticket!.Status == s.Name) {<option value="@s.Name" selected>@s.Name</option>} else {<option value="@s.Name">@s.Name</option>}
              }
            </select>
          </div>
          <div>
            <label class="label">Inventory Ref (SKU)</label>
            <input name="EditInventoryRef" value="@Model.Ticket!.InventoryRef" class="input input-bordered w-full" />
          </div>
          <div>
            <label class="label">Assignee</label>
            <input type="hidden" id="assignedUserId" name="assignedUserId" value="@Model.Ticket!.AssignedUserId" />
            <input id="assignee-search" class="input w-full" list="assignees-list" placeholder="Search assignee by name or email" />
            <datalist id="assignees-list">
              <option value="Unassigned" data-id=""></option>
              @foreach (var u in Model.Members)
              {
                <option value="@u.Name (@u.Email)" data-id="@u.Id"></option>
              }
            </datalist>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-primary" type="submit" id="ticket-save-btn">Save</button>
            <a class="btn btn-soft" asp-page="/Workspaces/Tickets" asp-route-slug="@Model.WorkspaceSlug" asp-preserve-query>Cancel</a>
          </div>
        </form>
        <div class="toast" id="save-toast" style="display:none;">
          <div class="alert alert-success"><span id="save-toast-msg">Saved.</span></div>
        </div>
        <div class="toast" id="save-error-toast" style="display:none;">
          <div class="alert alert-error"><span id="save-error-toast-msg">Save failed.</span></div>
        </div>
        <script>
          (function(){
            const statusColors = {
@for (int i = 0; i < Model.Statuses.Count; i++)
{
    var s = Model.Statuses[i];
    var color = string.IsNullOrWhiteSpace(s.Color) ? "neutral" : s.Color;
@:$"\"{s.Name.Replace("\"","\\\"")}\": \"{color}\"{(i < Model.Statuses.Count - 1 ? "," : string.Empty)}"
}
            };
            const priorityColors = {
      @for (int i = 0; i < Model.Priorities.Count; i++)
      {
        var p = Model.Priorities[i];
        var color = string.IsNullOrWhiteSpace(p.Color) ? "neutral" : p.Color;
      @:$"\"{p.Name.Replace("\"","\\\"")}\": \"{color}\"{(i < Model.Priorities.Count - 1 ? "," : string.Empty)}"
      }
            };
            const form = document.getElementById('ticket-save-form');
            if (!form) return;
            form.addEventListener('submit', async function(e){
              e.preventDefault();
              const btn = document.getElementById('ticket-save-btn');
              const fd = new FormData(form);
              const action = form.getAttribute('action') || window.location.pathname + window.location.search;
              try {
                if (btn){ btn.disabled = true; btn.classList.add('btn-disabled'); }
                const res = await fetch(action, { method: 'POST', body: fd, credentials: 'same-origin' });
                if (res.ok){
                  const toast = document.getElementById('save-toast');
                  const msg = document.getElementById('save-toast-msg');
                  if (toast && msg){
                    msg.textContent = 'Ticket saved.';
                    toast.style.display = '';
                    setTimeout(()=>{ toast.style.display = 'none'; }, 2500);
                  }
                  // Update header badges inline from current inputs
                  const subj = form.querySelector('[name="EditSubject"]').value;
                  const prio = form.querySelector('[name="EditPriority"]').value;
                  const status = form.querySelector('[name="EditStatus"]').value;
                  const inv = form.querySelector('[name="EditInventoryRef"]').value;
                  const assigneeHidden = form.querySelector('#assignedUserId');
                  const titleEl = document.querySelector('.card-title');
                  if (titleEl) titleEl.textContent = subj;
                  const badges = document.querySelectorAll('.card .badge');
                  if (badges && badges.length >= 2){
                    badges[0].textContent = prio;
                    const pc = priorityColors[prio] || 'neutral';
                    if ((typeof pc === 'string') && pc.startsWith('#')){
                      badges[0].className = 'badge badge-soft join-item';
                      badges[0].setAttribute('style', `background-color: ${pc}; color: #fff;`);
                    } else {
                      badges[0].className = `badge badge-soft badge-${pc} join-item`;
                      badges[0].removeAttribute('style');
                    }
                    badges[1].textContent = status;
                    const c = statusColors[status] || 'neutral';
                    if ((typeof c === 'string') && c.startsWith('#')){
                      badges[1].className = 'badge badge-soft join-item';
                      badges[1].setAttribute('style', `background-color: ${c}; color: #fff;`);
                    } else {
                      badges[1].className = `badge badge-soft badge-${c} join-item`;
                      badges[1].removeAttribute('style');
                    }
                  }
                } else {
                  const toast = document.getElementById('save-error-toast');
                  const msg = document.getElementById('save-error-toast-msg');
                  if (toast && msg){
                    msg.textContent = `Save failed (status ${res.status}).`;
                    toast.style.display = '';
                    setTimeout(()=>{ toast.style.display = 'none'; }, 3000);
                  }
                }
              } catch(err){
                const toast = document.getElementById('save-error-toast');
                const msg = document.getElementById('save-error-toast-msg');
                if (toast && msg){
                  msg.textContent = 'Save error. Please try again.';
                  toast.style.display = '';
                  setTimeout(()=>{ toast.style.display = 'none'; }, 3000);
                }
                console.error('Save error', err);
              } finally {
                if (btn){ btn.disabled = false; btn.classList.remove('btn-disabled'); }
              }
            });
            // Wire assignee datalist to hidden field
            const hidden = document.getElementById('assignedUserId');
            const input = document.getElementById('assignee-search');
            const list = document.getElementById('assignees-list');
            if (hidden && input && list){
              function setFromText(){
                const val = input.value;
                const opts = Array.from(list.querySelectorAll('option'));
                const matched = opts.find(o => o.value === val);
                if (matched) {
                  hidden.value = matched.getAttribute('data-id') || '';
                } else if (val === '' || val.toLowerCase() === 'unassigned') {
                  hidden.value = '';
                }
              }
              input.addEventListener('change', setFromText);
              input.addEventListener('blur', function(){
                setFromText();
                if ((hidden.value ?? '') === '' && (input.value === '' || input.value.toLowerCase() === 'unassigned')){
                  input.value = 'Unassigned';
                  input.setAttribute('placeholder', 'Pick from list');
                }
              });
              input.addEventListener('focus', function(){
                if (input.value.toLowerCase() === 'unassigned') {
                  input.value = '';
                }
              });
              const preset = hidden.value ?? '';
              if (preset !== ''){
                const opt = Array.from(list.querySelectorAll('option')).find(o => o.getAttribute('data-id') === preset);
                if (opt) input.value = opt.value;
              } else {
                input.value = 'Unassigned';
              }
            }
            // Wire contact datalist to hidden field
            const ch = document.getElementById('editContactId');
            const ci = document.getElementById('contact-search');
            const cl = document.getElementById('contacts-list');
            if (ch && ci && cl){
              function setContact(){
                const val = ci.value;
                const opts = Array.from(cl.querySelectorAll('option'));
                const matched = opts.find(o => o.value === val);
                if (matched) {
                  ch.value = matched.getAttribute('data-id') || '';
                }
              }
              ci.addEventListener('change', setContact);
              // Prefill display from current contact
              const preset = ch.value ?? '';
              if (preset !== ''){
                const opt = Array.from(cl.querySelectorAll('option')).find(o => o.getAttribute('data-id') === preset);
                if (opt) ci.value = opt.value;
              }
            }
          })();
        </script>
        <div class="divider"></div>
      </div>
    </div>
  }
  </div>
  </section>
</div>
