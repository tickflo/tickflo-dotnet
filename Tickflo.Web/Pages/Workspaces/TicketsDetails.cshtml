@page "/workspaces/{slug}/tickets/{id:int}"
@model Tickflo.Web.Pages.Workspaces.TicketsDetailsModel
@{
    ViewData["Title"] = "Ticket Details";
}

<div class="flex flex-row gap-4">
  @await Html.PartialAsync("_WorkspaceSidebar", Model.WorkspaceSlug)
  <section class="p-6 flex-1">
@{
  var sectionTitle = (Model.Ticket == null || Model.Ticket.Id == 0) ? "New Ticket" : "Ticket Details";
}
@await Html.PartialAsync("_WorkspaceHeader", new Tickflo.Web.Pages.Shared.WorkspaceHeaderView { Slug = Model.WorkspaceSlug, Name = Model.Workspace?.Name ?? "Workspace", SectionTitle = sectionTitle })

<div class="grid gap-4">
  <div class="flex items-center justify-between">
    <div class="join">
      @{
      }
      <a class="btn btn-soft join-item btn-sm md:btn-md" asp-page="/Workspaces/Tickets" asp-route-slug="@Model.WorkspaceSlug" asp-preserve-query>Back to list</a>
    </div>
  </div>

  <div class="card bg-base-100">
    <div class="card-body gap-2">
      <div class="flex items-center justify-between flex-wrap gap-2">
        <h2 class="card-title">@Model.Ticket?.Subject</h2>
      </div>
      <div class="join">
        @{
          var tColor = (Model.Ticket != null && Model.TypeColorByName.TryGetValue(Model.Ticket.Type, out var tc)) ? tc : "neutral";
          var tIsHex = tColor.StartsWith("#");
          var tCls = tIsHex ? "badge badge-soft join-item" : $"badge badge-soft badge-{tColor} join-item";
          var tStyle = tIsHex ? $"background-color: {tColor}; color: #fff;" : null;
        }
        <span class="@tCls" style="@tStyle">@Model.Ticket?.Type</span>
        @{
          var pColor = (Model.Ticket != null && Model.PriorityColorByName.TryGetValue(Model.Ticket.Priority, out var pc)) ? pc : "neutral";
          var pIsHex = pColor.StartsWith("#");
          var pCls = pIsHex ? "badge badge-soft join-item" : $"badge badge-soft badge-{pColor} join-item";
          var pStyle = pIsHex ? $"background-color: {pColor}; color: #fff;" : null;
        }
        <span class="@pCls" style="@pStyle">@Model.Ticket?.Priority</span>
        @{
          var sColor = (Model.Ticket != null && Model.StatusColorByName.TryGetValue(Model.Ticket.Status, out var c)) ? c : "neutral";
          var isHex = sColor.StartsWith("#");
          var sCls = isHex ? "badge badge-soft join-item" : $"badge badge-soft badge-{sColor} join-item";
          var sStyle = isHex ? $"background-color: {sColor}; color: #fff;" : null;
        }
        <span class="@sCls" style="@sStyle">@Model.Ticket?.Status</span>
      </div>
      <div class="text-sm opacity-70">Created @Model.Ticket?.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</div>
      @if(Model.Contact != null)
      {
        <div>Contact: <span class="font-medium">@Model.Contact.Name</span> <span class="opacity-70">(@Model.Contact.Email)</span></div>
      }
      @if(Model.Ticket?.AssignedUserId != null)
      {
        <div>
          Assignee:
          <a class="link" href="/workspaces/@Model.WorkspaceSlug/tickets?AssigneeUserId=@Model.Ticket!.AssignedUserId" asp-preserve-query>View all for assignee</a>
        </div>
      }
      @if(Model.Ticket?.AssignedTeamId != null)
      {
        var team = Model.Teams.FirstOrDefault(t => t.Id == Model.Ticket!.AssignedTeamId);
        if (team != null)
        {
          <div>Team: <span class="badge badge-soft">@team.Name</span></div>
        }
      }
      <div class="prose max-w-none">
        <p>@Model.Ticket?.Description</p>
      </div>
    </div>
  </div>

  @{
    var isNewTicket = (Model.Ticket == null || Model.Ticket.Id == 0);
    var canSubmit = isNewTicket ? Model.CanCreateTickets : Model.CanEditTickets;
  }
  @if(Model.CanViewTickets)
  {
    <div class="card bg-base-100">
      <div class="card-body">
        <form method="post" asp-page-handler="Save" asp-route-slug="@Model.WorkspaceSlug" asp-route-id="@(@Model.Ticket?.Id ?? 0)" class="grid gap-3" id="ticket-save-form" data-can-submit="@canSubmit.ToString().ToLower()">
          <input type="hidden" name="slug" value="@Model.WorkspaceSlug" />
             <input type="hidden" name="id" value="@Model.Ticket?.Id ?? 0" />
          <!-- Subject first -->
          <div>
            <label class="label">Subject</label>
            <input name="EditSubject" value="@Model.Ticket!.Subject" class="input input-bordered w-full" />
          </div>
          <!-- Description next -->
          <div>
            <label class="label">Description</label>
            <textarea name="EditDescription" class="textarea textarea-bordered w-full" rows="6">@Model.Ticket!.Description</textarea>
          </div>
          <!-- Core metadata: Type / Status / Priority -->
          <div class="grid gap-2 md:grid-cols-3">
            <div>
              <label class="label">Type</label>
              <select name="EditType" class="select select-bordered w-full">
                @foreach (var t in Model.Types)
                {
                  if (Model.Ticket!.Type == t.Name) {<option value="@t.Name" selected>@t.Name</option>} else {<option value="@t.Name">@t.Name</option>}
                }
              </select>
            </div>
            <div>
              <label class="label">Status</label>
              <select name="EditStatus" class="select select-bordered w-full">
                @foreach (var s in Model.Statuses)
                {
                  if (Model.Ticket!.Status == s.Name) {<option value="@s.Name" selected>@s.Name</option>} else {<option value="@s.Name">@s.Name</option>}
                }
              </select>
            </div>
            <div>
              <label class="label">Priority</label>
              <select name="EditPriority" class="select select-bordered w-full">
                @foreach (var p in Model.Priorities)
                {
                  if (Model.Ticket!.Priority == p.Name) {<option value="@p.Name" selected>@p.Name</option>} else {<option value="@p.Name">@p.Name</option>}
                }
              </select>
            </div>
          </div>
          <!-- Assignment: Assignee / Team -->
          <div class="grid gap-2 md:grid-cols-2">
            <div>
              <label class="label">Assignee</label>
              <input type="hidden" id="assignedUserId" name="assignedUserId" value="@Model.Ticket!.AssignedUserId" />
              <input id="assignee-search" class="input input-bordered w-full" list="assignees-list" placeholder="Search assignee by name or email" />
              <datalist id="assignees-list">
                <option value="Unassigned" data-id=""></option>
                @foreach (var u in Model.Members)
                {
                  <option value="@u.Name (@u.Email)" data-id="@u.Id"></option>
                }
              </datalist>
            </div>
            <div>
              <label class="label">Team</label>
              <input type="hidden" id="assignedTeamId" name="assignedTeamId" value="@Model.Ticket!.AssignedTeamId" />
              <input id="team-search" class="input input-bordered w-full" list="teams-list" placeholder="Search team by name" />
              <datalist id="teams-list">
                <option value="None" data-id=""></option>
                @foreach (var t in Model.Teams)
                {
                  <option value="@t.Name" data-id="@t.Id"></option>
                }
              </datalist>
            </div>
          </div>
          <!-- Contact -->
          <div>
            <label class="label">Contact</label>
            <input type="hidden" name="EditContactId" id="editContactId" value="@Model.Ticket!.ContactId" />
            <input id="contact-search" class="input input-bordered w-full" list="contacts-list" placeholder="Search contacts by name or email" />
            <datalist id="contacts-list">
              @foreach (var c in Model.Contacts)
              {
                <option value="@c.Name (@c.Email)" data-id="@c.Id"></option>
              }
            </datalist>
          </div>
          <!-- Parts / Inventory at the end -->
          <div>
            <label class="label">Parts / Inventory</label>
            <div id="inventory-products-section" class="card bg-base-200 p-3">
              <div class="flex flex-wrap gap-2 mb-2 items-center">
                <input id="inventory-search" class="input input-bordered grow" list="inventory-list" placeholder="Search inventory by name or SKU" />
                <input id="inventory-qty" type="number" min="1" value="1" class="input input-bordered w-20" aria-label="Quantity" placeholder="Qty" />
                <button type="button" class="btn btn-primary" id="add-inventory-btn">Add</button>
                <div class="ml-auto flex items-center gap-2">
                  <span id="invoice-count" class="badge">0 items</span>
                  <button type="button" class="btn btn-soft btn-sm" id="clear-invoice-btn">Clear</button>
                </div>
              </div>
              <datalist id="inventory-list">
                @foreach (var i in Model.InventoryItems)
                {
                  <option value="@i.Name (@i.Sku)" data-id="@i.Id" data-sku="@i.Sku" data-name="@i.Name" data-price="@((i.Price ?? i.Cost).ToString(System.Globalization.CultureInfo.InvariantCulture))" />
                }
              </datalist>
              <table class="table table-zebra table-md w-full" id="invoice-table">
                <thead>
                  <tr>
                    <th>SKU</th>
                    <th>Name</th>
                    <th>Qty</th>
                    <th>Unit Price</th>
                    <th>Total</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="invoice-body">
                  @* Rows will be dynamically added by JS *@
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="4" class="text-right font-bold">Total</td>
                    <td id="invoice-total" class="font-bold">$0.00</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
            <input type="hidden" name="TicketInventoriesJson" id="TicketInventoriesJson" />
          </div>
          <div class="flex gap-2">
            @{ var saveLabel = (Model.Ticket != null && Model.Ticket.Id > 0) ? "Update" : "Save"; }
            <button class="btn btn-primary" type="submit" id="ticket-save-btn" @(canSubmit ? "" : "disabled")>@saveLabel</button>
            <a class="btn btn-soft" asp-page="/Workspaces/Tickets" asp-route-slug="@Model.WorkspaceSlug" asp-preserve-query>Cancel</a>
          </div>
        </form>
        <div class="toast" id="save-toast" style="display:none;">
          <div class="alert alert-success"><span id="save-toast-msg">Saved.</span></div>
        </div>
        <div class="toast" id="save-error-toast" style="display:none;">
          <div class="alert alert-error"><span id="save-error-toast-msg">Save failed.</span></div>
        </div>
        <script>
          (function(){
            @{ var statusDict = new System.Collections.Generic.Dictionary<string, string>();
               foreach (var s in Model.Statuses)
               {
                 var key = s.Name ?? string.Empty;
                 var val = string.IsNullOrWhiteSpace(s.Color) ? "neutral" : s.Color!;
                 statusDict[key] = val;
               }
               var priorityDict = new System.Collections.Generic.Dictionary<string, string>();
               foreach (var p in Model.Priorities)
               {
                 var key = p.Name ?? string.Empty;
                 var val = string.IsNullOrWhiteSpace(p.Color) ? "neutral" : p.Color!;
                 priorityDict[key] = val;
               }
               var statusJson = System.Text.Json.JsonSerializer.Serialize(statusDict);
               var priorityJson = System.Text.Json.JsonSerializer.Serialize(priorityDict);
            }
            const statusColors = @Html.Raw(statusJson);
            const priorityColors = @Html.Raw(priorityJson);
            // Multi-inventory invoice logic
            /* inventoryList server emission disabled
            const inventoryListFromServer = [
              @foreach (var i in Model.InventoryItems)
              {
                @:{ sku: "@((i.Sku ?? string.Empty).Replace("\"","\\\"").Replace("\\","\\\\"))", name: "@((i.Name ?? string.Empty).Replace("\"","\\\"").Replace("\\","\\\\"))", id: @i.Id, price: @((i.Price ?? i.Cost).ToString(System.Globalization.CultureInfo.InvariantCulture)) }
                  @:{ sku: "@((i.Sku ?? string.Empty).Replace("\"","\\\"").Replace("\\","\\\\").Replace("\r"," ").Replace("\n"," "))", name: "@((i.Name ?? string.Empty).Replace("\"","\\\"").Replace("\\","\\\\").Replace("\r"," ").Replace("\n"," "))", id: @i.Id, price: @((i.Price ?? i.Cost).ToString(System.Globalization.CultureInfo.InvariantCulture)) }
                @:(Model.InventoryItems.Last() == i ? "" : ",")
              }
            ];
            */
            const inventoryList = (function(){
              const options = Array.from(document.querySelectorAll('#inventory-list option'));
              return options.map(opt => ({
                sku: opt.getAttribute('data-sku') || '',
                name: opt.getAttribute('data-name') || '',
                id: parseInt(opt.getAttribute('data-id') || '0', 10),
                price: (parseFloat(opt.getAttribute('data-price') || '0') || 0)
              }));
            })();
            const invoiceBody = document.getElementById('invoice-body');
            const invoiceTotal = document.getElementById('invoice-total');
            const ticketInventoriesJson = document.getElementById('TicketInventoriesJson');
            let invoiceItems = [];

            function renderInvoice() {
              invoiceBody.innerHTML = '';
              let total = 0;
              invoiceItems.forEach((item, idx) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${item.sku}</td>
                                 <td>${item.name}</td>
                                 <td class='flex items-center gap-1'>
                                   <button type='button' class='btn btn-xs' data-action='dec' data-idx='${idx}'>â€“</button>
                                   <input type='number' min='1' value='${item.quantity}' class='input input-bordered input-xs w-16 qty-input' data-idx='${idx}' />
                                   <button type='button' class='btn btn-xs' data-action='inc' data-idx='${idx}'>+</button>
                                 </td>
                                 <td>
                                   <div class='flex items-center gap-1'>
                                     <span>$</span>
                                     <input type='number' min='0' step='0.01' value='${item.unitPrice.toFixed(2)}' class='input input-bordered input-xs w-24 price-input' data-idx='${idx}' />
                                   </div>
                                 </td>
                                 <td>$${(item.unitPrice * item.quantity).toFixed(2)}</td>
                                 <td><button type='button' class='btn btn-error btn-xs remove-btn' data-idx='${idx}'>Remove</button></td>`;
                invoiceBody.appendChild(row);
                total += item.unitPrice * item.quantity;
              });
              invoiceTotal.textContent = `$${total.toFixed(2)}`;
              ticketInventoriesJson.value = JSON.stringify(invoiceItems);
              const cnt = invoiceItems.reduce((a,b)=>a+b.quantity,0);
              const countBadge = document.getElementById('invoice-count');
              if (countBadge) countBadge.textContent = `${cnt} item${cnt===1?'':'s'}`;
            }

            function addItemResolved(item, qty){
              if (!item) return false;
              const existing = invoiceItems.find(ii => ii.id === item.id);
              if (existing){
                existing.quantity += qty;
              } else {
                invoiceItems.push({ sku: item.sku, name: item.name, id: item.id, quantity: qty, unitPrice: item.price });
              }
              renderInvoice();
              return true;
            }

            function handleAddClick(){
              const searchInput = document.getElementById('inventory-search');
              const qtyInput = document.getElementById('inventory-qty');
              const listEl = document.getElementById('inventory-list');
              const searchRaw = (searchInput?.value || '').trim();
              const search = searchRaw.toLowerCase();
              const qty = parseInt(qtyInput?.value || '1', 10) || 1;
              let item = null;
              // Prefer an exact match from datalist options to get canonical id/sku/name/price
              if (listEl && searchRaw !== '') {
                const opts = Array.from(listEl.querySelectorAll('option'));
                const matched = opts.find(o => (o.getAttribute('value') || '').toLowerCase() === search);
                if (matched) {
                  const id = parseInt(matched.getAttribute('data-id') || '0', 10);
                  const sku = matched.getAttribute('data-sku') || '';
                  const name = matched.getAttribute('data-name') || searchRaw;
                  const priceStr = matched.getAttribute('data-price') || '0';
                  const price = parseFloat(priceStr);
                  item = { id, sku, name, price: isNaN(price) ? 0 : price };
                }
              }
              // Fallback: case-insensitive, partial, and exact matches on local list
              if (!item) {
                item = inventoryList.find(i =>
                  search === `${i.name.toLowerCase()} (${i.sku.toLowerCase()})` ||
                  search === i.sku.toLowerCase() ||
                  search === i.name.toLowerCase()
                ) || inventoryList.find(i =>
                  i.name.toLowerCase().includes(search) || i.sku.toLowerCase().includes(search)
                );
              }
              if (addItemResolved(item, qty)){
                if (searchInput) searchInput.value = '';
                if (qtyInput) qtyInput.value = '1';
              } else {
                alert('No matching inventory item found.');
              }
            }
            function bindAddButton(){
              const addBtn = document.getElementById('add-inventory-btn');
              if (addBtn) {
                addBtn.addEventListener('click', handleAddClick);
              } else {
                // Fallback for dynamic render: delegate on document
                document.addEventListener('click', function(e){
                  const t = e.target;
                  if (t && (t.id === 'add-inventory-btn' || (t.closest && t.closest('#add-inventory-btn')))){
                    handleAddClick();
                  }
                });
              }
            }
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', bindAddButton);
            } else {
              bindAddButton();
            }

            // Allow Enter key to add when focused in inventory-search
            document.getElementById('inventory-search').addEventListener('keydown', function(e){
              if (e.key === 'Enter') {
                e.preventDefault();
                const btn = document.getElementById('add-inventory-btn');
                if (btn) btn.click();
              }
            });

            const clearBtn = document.getElementById('clear-invoice-btn');
            if (clearBtn){
              clearBtn.addEventListener('click', function(){
                invoiceItems = [];
                renderInvoice();
              });
            }

            invoiceBody.addEventListener('click', function(e) {
              const btn = e.target && e.target.closest ? e.target.closest('button') : null;
              if (!btn) return;
              const idx = parseInt(btn.getAttribute('data-idx') || '-1', 10);
              const action = btn.getAttribute('data-action');
              if (action){
                if (!isNaN(idx) && invoiceItems[idx]){
                  if (action === 'inc') invoiceItems[idx].quantity += 1;
                  if (action === 'dec') invoiceItems[idx].quantity = Math.max(1, invoiceItems[idx].quantity - 1);
                  renderInvoice();
                }
                return;
              }
              if (btn.classList.contains('remove-btn')){
                if (!isNaN(idx)){
                  invoiceItems.splice(idx, 1);
                  renderInvoice();
                }
              }
            });

            // Handle inline quantity changes
            invoiceBody.addEventListener('input', function(e){
              const el = e.target;
              if (el && el.classList.contains('qty-input')){
                const idx = parseInt(el.getAttribute('data-idx') || '-1', 10);
                const qty = Math.max(1, parseInt(el.value || '1', 10));
                if (!isNaN(idx) && invoiceItems[idx]){
                  invoiceItems[idx].quantity = qty;
                  renderInvoice();
                }
              }
              if (el && el.classList.contains('price-input')){
                const idx = parseInt(el.getAttribute('data-idx') || '-1', 10);
                let price = parseFloat(el.value || '0');
                if (isNaN(price) || price < 0) price = 0;
                if (!isNaN(idx) && invoiceItems[idx]){
                  invoiceItems[idx].unitPrice = price;
                  renderInvoice();
                }
              }
            });

            // On page load, populate invoiceItems from Model.Ticket.TicketInventories if editing
            @{ var preItems = (Model.Ticket?.TicketInventories ?? new List<Tickflo.Core.Entities.TicketInventory>())
                  .Select(ti => new {
                    sku = ti.Inventory?.Sku ?? string.Empty,
                    name = ti.Inventory?.Name ?? string.Empty,
                    id = ti.InventoryId,
                    quantity = ti.Quantity,
                    unitPrice = ti.UnitPrice
                  }).ToList();
               var preJson = System.Text.Json.JsonSerializer.Serialize(preItems);
            }
            invoiceItems = @Html.Raw(preJson);
            renderInvoice();
            const form = document.getElementById('ticket-save-form');
            if (!form) return;
            form.addEventListener('submit', async function(e){
              e.preventDefault();
              // Block if user lacks create/edit permission
              const canSubmitAttr = form.getAttribute('data-can-submit');
              const canSubmit = (canSubmitAttr === 'true');
              if (!canSubmit) {
                const toast = document.getElementById('save-error-toast');
                const msg = document.getElementById('save-error-toast-msg');
                if (toast && msg){
                  msg.textContent = 'You do not have permission to save this ticket.';
                  toast.style.display = '';
                  setTimeout(()=>{ toast.style.display = 'none'; }, 3000);
                }
                return;
              }
              // Ensure hidden JSON reflects latest invoiceItems
              try { ticketInventoriesJson.value = JSON.stringify(invoiceItems); } catch {}
              const btn = document.getElementById('ticket-save-btn');
              const fd = new FormData(form);
              let action = form.getAttribute('action');
              if (!action || action.trim() === '') {
                const qs = window.location.search;
                const hasHandler = qs.includes('handler=');
                const handlerParam = hasHandler ? '' : (qs && qs.length > 1 ? '&handler=Save' : '?handler=Save');
                action = window.location.pathname + qs + handlerParam;
              }
              try {
                if (btn){ btn.disabled = true; btn.classList.add('btn-disabled'); }
                const res = await fetch(action, { method: 'POST', body: fd, credentials: 'same-origin' });
                if (res.ok){
                  // Navigate back to list, preserving filters from current query string
                  const qs = window.location.search || '';
                  window.location.href = `/workspaces/@Model.WorkspaceSlug/tickets${qs}`;
                } else {
                  const toast = document.getElementById('save-error-toast');
                  const msg = document.getElementById('save-error-toast-msg');
                  if (toast && msg){
                    msg.textContent = `Save failed (status ${res.status}).`;
                    toast.style.display = '';
                    setTimeout(()=>{ toast.style.display = 'none'; }, 3000);
                  }
                }
              } catch(err){
                const toast = document.getElementById('save-error-toast');
                const msg = document.getElementById('save-error-toast-msg');
                if (toast && msg){
                  msg.textContent = 'Save error. Please try again.';
                  toast.style.display = '';
                  setTimeout(()=>{ toast.style.display = 'none'; }, 3000);
                }
                console.error('Save error', err);
              } finally {
                if (btn){ btn.disabled = false; btn.classList.remove('btn-disabled'); }
              }
            });
            // Wire assignee datalist to hidden field
            const hidden = document.getElementById('assignedUserId');
            const input = document.getElementById('assignee-search');
            const list = document.getElementById('assignees-list');
            if (hidden && input && list){
              function setFromText(){
                const val = input.value;
                const opts = Array.from(list.querySelectorAll('option'));
                const matched = opts.find(o => o.value === val);
                if (matched) {
                  hidden.value = matched.getAttribute('data-id') || '';
                } else if (val === '' || val.toLowerCase() === 'unassigned') {
                  hidden.value = '';
                }
              }
              input.addEventListener('change', setFromText);
              input.addEventListener('blur', function(){
                setFromText();
                if ((hidden.value ?? '') === '' && (input.value === '' || input.value.toLowerCase() === 'unassigned')){
                  input.value = 'Unassigned';
                  input.setAttribute('placeholder', 'Pick from list');
                }
              });
              input.addEventListener('focus', function(){
                if (input.value.toLowerCase() === 'unassigned') {
                  input.value = '';
                }
              });
              const preset = hidden.value ?? '';
              if (preset !== ''){
                const opt = Array.from(list.querySelectorAll('option')).find(o => o.getAttribute('data-id') === preset);
                if (opt) input.value = opt.value;
              } else {
                input.value = 'Unassigned';
              }
            }
            // Wire team datalist to hidden field
            const th = document.getElementById('assignedTeamId');
            const ti = document.getElementById('team-search');
            const tl = document.getElementById('teams-list');
            if (th && ti && tl){
              function setTeam(){
                const val = ti.value;
                const opts = Array.from(tl.querySelectorAll('option'));
                const matched = opts.find(o => o.value === val);
                if (matched) {
                  th.value = matched.getAttribute('data-id') || '';
                } else if (val === '' || val.toLowerCase() === 'none') {
                  th.value = '';
                }
              }
              ti.addEventListener('change', setTeam);
              ti.addEventListener('blur', function(){
                setTeam();
                if ((th.value ?? '') === '' && (ti.value === '' || ti.value.toLowerCase() === 'none')){
                  ti.value = 'None';
                  ti.setAttribute('placeholder', 'Pick from list');
                }
              });
              ti.addEventListener('focus', function(){
                if (ti.value.toLowerCase() === 'none') {
                  ti.value = '';
                }
              });
              const tpreset = th.value ?? '';
              if (tpreset !== ''){
                const opt = Array.from(tl.querySelectorAll('option')).find(o => o.getAttribute('data-id') === tpreset);
                if (opt) ti.value = opt.value;
              } else {
                ti.value = 'None';
              }
            }
            // Wire contact datalist to hidden field
            const ch = document.getElementById('editContactId');
            const ci = document.getElementById('contact-search');
            const cl = document.getElementById('contacts-list');
            if (ch && ci && cl){
              function setContact(){
                const val = ci.value;
                const opts = Array.from(cl.querySelectorAll('option'));
                const matched = opts.find(o => o.value === val);
                if (matched) {
                  ch.value = matched.getAttribute('data-id') || '';
                }
              }
              ci.addEventListener('change', setContact);
              // Prefill display from current contact
              const preset = ch.value ?? '';
              if (preset !== ''){
                const opt = Array.from(cl.querySelectorAll('option')).find(o => o.getAttribute('data-id') === preset);
                if (opt) ci.value = opt.value;
              }
            }
          })();
        </script>
        <div class="divider"></div>
        @if ((Model.Ticket?.Id ?? 0) > 0)
        {
          <h3 class="text-lg font-semibold mb-2">History</h3>
          <div class="grid gap-2">
            @if (Model.History != null && Model.History.Count > 0)
            {
              foreach (var h in Model.History)
              {
                var actor = Model.Members.FirstOrDefault(m => m.Id == h.CreatedByUserId);
                var actorName = actor != null ? (string.IsNullOrWhiteSpace(actor.Name) ? actor.Email : actor.Name) : $"User #{h.CreatedByUserId}";
                <div class="flex items-start gap-2">
                  <div class="badge badge-soft">@h.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</div>
                  @if ((h.Action ?? string.Empty) == "created")
                  {
                    <div><span class="font-medium">@actorName</span> created the ticket.</div>
                  }
                  else if ((h.Action ?? string.Empty) == "field_changed")
                  {
                    <div>
                      <span class="font-medium">@actorName</span> changed <span class="font-medium">@h.Field</span>
                      from <span class="opacity-70">@((h.OldValue ?? "(empty)"))</span>
                      to <span class="opacity-70">@((h.NewValue ?? "(empty)"))</span>.
                    </div>
                  }
                  else
                  {
                    <div><span class="font-medium">@actorName</span> @h.Action @h.Note</div>
                  }
                </div>
              }
            }
            else
            {
              <div class="opacity-60">No history yet.</div>
            }
          </div>
        }
      </div>
    </div>
  }
  </div>
  </section>
</div>
