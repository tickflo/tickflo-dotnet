@page "/workspaces/{slug}/users/teams/{id:int}/edit"
@model Tickflo.Web.Pages.Workspaces.TeamsEditModel
@{
    ViewData["Title"] = @Model.Id == 0 ? "New Team" : "Edit Team";
}

<div class="flex flex-row gap-4">
    @await Html.PartialAsync("_WorkspaceSidebar", Model.WorkspaceSlug)
    <section class="relative overflow-hidden p-6 flex-1 space-y-8 text-slate-100 rounded-3xl bg-gradient-to-br from-[#0c1220] via-[#0b101b] to-[#0a0f18]">
        @await Html.PartialAsync("_WorkspaceHeader", new Tickflo.Web.Pages.Shared.WorkspaceHeaderView { Slug = Model.WorkspaceSlug, Name = Model.Workspace?.Name ?? "Workspace", SectionTitle = (Model.Id == 0 ? "New Team" : "Edit Team"), AllowNewAction = Model.CanCreateTeams, NewActionLabel = "New Team", NewActionHref = $"/workspaces/{Model.WorkspaceSlug}/users/teams/0/edit" })
        <div class="card bg-neutral-900/85 backdrop-blur shadow-2xl rounded-3xl text-slate-100">
            <div class="card-body">
                <form method="post" class="grid gap-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text">Name</span></label>
                        <input class="input input-bordered validator w-full" asp-for="Name" />
                        <span class="validator-hint text-xs text-error" asp-validation-for="Name"></span>
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Description</span></label>
                        <textarea class="textarea textarea-bordered w-full" asp-for="Description"></textarea>
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Members (optional)</span></label>
                        <div class="join w-full">
                            <input id="member-search" class="input input-bordered join-item w-full" list="members-list" placeholder="Search members by name or email" />
                            <button type="button" id="member-add-btn" class="btn btn-soft join-item">Add</button>
                        </div>
                        <datalist id="members-list">
                            @foreach (var user in Model.WorkspaceUsers)
                            {
                                <option value="@user.Name (@user.Email)" data-id="@user.Id"></option>
                            }
                        </datalist>
                        <div id="selected-members" class="flex flex-wrap gap-2 mt-2">
                            @foreach (var mid in Model.SelectedMemberIds)
                            {
                                var user = Model.WorkspaceUsers.FirstOrDefault(x => x.Id == mid);
                                if (user != null)
                                {
                                    <span class="badge badge-soft rounded-full" data-id="@user.Id">
                                        @user.Name (@user.Email)
                                        <button type="button" class="btn btn-ghost btn-sm ml-2 remove-member" aria-label="Remove" title="Remove">✕</button>
                                    </span>
                                    <input type="hidden" name="SelectedMemberIds" value="@user.Id" />
                                }
                            }
                        </div>
                        <span class="validator-hint">Search and add members. Click ✕ to remove.</span>
                    </div>
                    <div class="join md:join">
                        @{ var saveLabel = (Model.Id == 0) ? "Create" : "Update"; }
                        <button type="submit" class="btn btn-primary join-item btn-sm w-full md:w-auto" @( (Model.Id == 0 ? Model.CanCreateTeams : Model.CanEditTeams) ? "" : "disabled")>@saveLabel</button>
                        <a class="btn btn-soft join-item btn-sm" asp-page="/Workspaces/Teams" asp-route-slug="@Model.WorkspaceSlug" asp-preserve-query>Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </section>
</div>
<script>
    (function(){
        const input = document.getElementById('member-search');
        const list = document.getElementById('members-list');
        const addBtn = document.getElementById('member-add-btn');
        const selected = document.getElementById('selected-members');
        if (!input || !list || !addBtn || !selected) return;

        function getSelectedIds(){
            return Array.from(selected.querySelectorAll('span.badge[data-id]')).map(el => parseInt(el.getAttribute('data-id')));
        }

        function findOptionByText(text){
            const opts = Array.from(list.querySelectorAll('option'));
            return opts.find(o => o.value === text);
        }

        function addMemberFromInput(){
            const text = input.value.trim();
            if (!text) return;
            const opt = findOptionByText(text);
            if (!opt) return; // must pick from list
            const idStr = opt.getAttribute('data-id');
            const id = idStr ? parseInt(idStr) : 0;
            if (!id) return;
            const current = new Set(getSelectedIds());
            if (current.has(id)) { input.value = ''; return; }
            const badge = document.createElement('span');
            badge.className = 'badge badge-soft';
            badge.setAttribute('data-id', String(id));
            badge.textContent = text + ' ';
            const remove = document.createElement('button');
            remove.type = 'button';
            remove.className = 'btn btn-ghost btn-sm ml-2 remove-member';
            remove.setAttribute('aria-label', 'Remove');
            remove.setAttribute('title', 'Remove');
            remove.textContent = '✕';
            remove.addEventListener('click', function(){
                // remove hidden input
                const hid = selected.querySelector('input[type="hidden"][name="SelectedMemberIds"][value="'+id+'"]');
                if (hid) hid.remove();
                badge.remove();
            });
            badge.appendChild(remove);
            selected.appendChild(badge);
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'SelectedMemberIds';
            hidden.value = String(id);
            selected.appendChild(hidden);
            input.value = '';
        }

        addBtn.addEventListener('click', addMemberFromInput);
        input.addEventListener('change', function(){
            // Allow pressing Enter to add when matched
            const opt = findOptionByText(input.value.trim());
            if (opt) addMemberFromInput();
        });

        // Wire existing remove buttons
        Array.from(selected.querySelectorAll('button.remove-member')).forEach(btn => {
            btn.addEventListener('click', function(){
                const parent = btn.parentElement;
                if (!parent) return;
                const id = parent.getAttribute('data-id');
                const hid = selected.querySelector('input[type="hidden"][name="SelectedMemberIds"][value="'+id+'"]');
                if (hid) hid.remove();
                parent.remove();
            });
        });
    })();
</script>
