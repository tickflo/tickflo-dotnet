@page "/workspaces/{slug}/users/roles"
@model Tickflo.Web.Pages.Workspaces.RolesModel
@{
    ViewData["Title"] = "Roles";
}

<div class="flex">
    @await Html.PartialAsync("_WorkspaceSidebar", Model.WorkspaceSlug)
    <section class="p-6 flex-1">
        @await Html.PartialAsync("_WorkspaceHeader", new Tickflo.Web.Pages.Shared.WorkspaceHeaderView { Slug = Model.WorkspaceSlug, Name = Model.Workspace?.Name ?? "Workspace", SectionTitle = "User Roles", NewActionLabel = "New Role", NewActionHref = $"/workspaces/{Model.WorkspaceSlug}/users/roles/new" })
        <h1 class="text-2xl font-bold">Roles</h1>
        @if (TempData["Error"] is string err && !string.IsNullOrWhiteSpace(err))
        {
            <div class="alert alert-error mt-3">
                <span>@err</span>
            </div>
        }
        <p class="mt-2 text-sm text-muted">Workspace: @Model.WorkspaceSlug</p>
        <div class="mt-4 space-y-4">
            <table class="min-w-full text-sm">
                <thead>
                    <tr class="text-left">
                        <th class="px-2 py-1">Name</th>
                        <th class="px-2 py-1">Admin</th>
                        <th class="px-2 py-1">Assigned Users</th>
                        <th class="px-2 py-1">Actions</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var role in Model.Roles)
                {
                    <tr class="border-t">
                        <td class="px-2 py-1">@role.Name</td>
                        <td class="px-2 py-1">@(role.Admin ? "Yes" : "No")</td>
                        <td class="px-2 py-1">@Model.RoleAssignmentCounts.GetValueOrDefault(role.Id)</td>
                        <td class="px-2 py-1">
                            <a class="text-blue-600" href="/workspaces/@Model.WorkspaceSlug/users/roles/@role.Id/edit">Edit</a>
                            <form method="post" action="/workspaces/@Model.WorkspaceSlug/users/roles/@role.Id/delete" style="display:inline" onsubmit="return confirm('Delete role @role.Name?');">
                                <button class="text-red-600 ml-2" type="submit" @(Model.RoleAssignmentCounts.GetValueOrDefault(role.Id) > 0 ? "disabled" : "")>Delete</button>
                            </form>
                            @if (Model.RoleAssignmentCounts.GetValueOrDefault(role.Id) > 0)
                            {
                                <span class="text-sm text-muted ml-2">Unassign users before deleting.</span>
                            }
                        </td>
                    </tr>
                }
                </tbody>
            </table>
            <div class="mt-3 flex gap-2">
                <a class="btn btn-primary" href="/workspaces/@Model.WorkspaceSlug/users/roles/new">Create Role</a>
                <a class="btn" href="/workspaces/@Model.WorkspaceSlug/users/roles/assign">Assign Users to Roles</a>
            </div>
        </div>
    </section>
</div>
