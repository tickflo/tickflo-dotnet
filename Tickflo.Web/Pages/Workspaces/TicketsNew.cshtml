@page "/workspaces/{slug}/tickets/new"
@model Tickflo.Web.Pages.Workspaces.TicketsNewModel
@{
    ViewData["Title"] = "New Ticket";
}
<div class="flex flex-row gap-4">
    @await Html.PartialAsync("_WorkspaceSidebar", Model.WorkspaceSlug)
    <section class="p-6 flex-1">
        @await Html.PartialAsync("_WorkspaceHeader", new Tickflo.Web.Pages.Shared.WorkspaceHeaderView { Slug = Model.WorkspaceSlug, Name = Model.Workspace?.Name ?? "Workspace", SectionTitle = "New Ticket" })
        <form class="mt-4 max-w-xl" method="post">
            <div class="fieldset">
                <label class="label"><span class="label-text">Contact</span></label>
                <input type="hidden" asp-for="ContactId" />
                <input id="contact-search" class="input w-full" list="contacts-list" placeholder="Search contacts by name or email" />
                <datalist id="contacts-list">
                    @foreach (var c in Model.Contacts)
                    {
                        <option value="@c.Name (@c.Email)" data-id="@c.Id"></option>
                    }
                </datalist>
                <span class="validator-hint" asp-validation-for="ContactId"></span>
            </div>
            <div class="fieldset">
                <label class="label"><span class="label-text">Assignee</span></label>
                <input type="hidden" asp-for="AssignedUserId" />
                <input id="assignee-search" class="input w-full" list="assignees-list" placeholder="Search members by name or email" />
                <datalist id="assignees-list">
                    <option value="Unassigned" data-id=""></option>
                    @foreach (var u in Model.Members)
                    {
                        <option value="@u.Name (@u.Email)" data-id="@u.Id"></option>
                    }
                </datalist>
                <span class="validator-hint" asp-validation-for="AssignedUserId"></span>
            </div>
            <div class="fieldset">
                <label class="label"><span class="label-text">Subject</span></label>
                <input class="input validator w-full" asp-for="Subject" />
                <span class="validator-hint" asp-validation-for="Subject"></span>
            </div>
            <div class="fieldset">
                <label class="label"><span class="label-text">Description</span></label>
                <textarea class="textarea validator w-full" asp-for="Description"></textarea>
                <span class="validator-hint" asp-validation-for="Description"></span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="fieldset">
                    <label class="label"><span class="label-text">Priority</span></label>
                    <select class="select validator w-full" asp-for="Priority">
                        <option>Low</option>
                        <option>Normal</option>
                        <option>High</option>
                        <option>Urgent</option>
                    </select>
                    <span class="validator-hint" asp-validation-for="Priority"></span>
                </div>
                <div class="fieldset">
                    <label class="label"><span class="label-text">Inventory Ref (SKU)</span></label>
                    <input class="input validator w-full" asp-for="InventoryRef" />
                    <span class="validator-hint" asp-validation-for="InventoryRef"></span>
                </div>
            </div>
            <div class="mt-4 flex gap-2">
                <button type="submit" class="btn btn-primary w-full md:w-auto">Create Ticket</button>
                <a class="btn" href="/workspaces/@Model.WorkspaceSlug/tickets" asp-preserve-query>Cancel</a>
            </div>
        </form>
        <script>
            (function () {
                function wireDatalist(hiddenSelector, inputId, listId, emptyValue) {
                    const hidden = document.querySelector(hiddenSelector);
                    const input = document.getElementById(inputId);
                    const list = document.getElementById(listId);
                    if (!hidden || !input || !list) return;
                    function setFromText() {
                        const val = input.value;
                        const opts = list.querySelectorAll('option');
                        let matched = Array.from(opts).find(opt => opt.value === val);
                        if (matched) {
                            hidden.value = matched.getAttribute('data-id') ?? emptyValue;
                        } else if (val === '' || val.toLowerCase() === 'unassigned') {
                            hidden.value = emptyValue;
                        } else {
                            hidden.value = emptyValue;
                        }
                    }
                    input.addEventListener('change', setFromText);
                        input.addEventListener('blur', function(){
                            setFromText();
                            // If no valid selection, show hint text
                            const isEmpty = hidden.value === emptyValue;
                            if (isEmpty && (input.value === '' || input.value.toLowerCase() === 'unassigned')) {
                                input.value = 'Unassigned';
                                input.setAttribute('placeholder', 'Pick from list');
                            }
                        });
                    input.addEventListener('focus', function(){
                        if (input.value.toLowerCase() === 'unassigned') {
                            input.value = '';
                        }
                    });
                    const preset = hidden.value;
                    if (preset !== undefined && preset !== null && preset !== '' && preset !== emptyValue) {
                        const opt = Array.from(list.querySelectorAll('option')).find(o => o.getAttribute('data-id') === preset);
                        if (opt) input.value = opt.value;
                    } else if (emptyValue === '') {
                        input.value = 'Unassigned';
                    }
                }
                wireDatalist('input[name="ContactId"]', 'contact-search', 'contacts-list', '0');
                wireDatalist('input[name="AssignedUserId"]', 'assignee-search', 'assignees-list', '');
            })();
        </script>
    </section>
</div>
