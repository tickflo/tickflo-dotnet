@page "/workspace/{slug}/files"
@model Tickflo.Web.Pages.Workspaces.FilesModel
@{
    ViewData["Title"] = "File Manager";
    Layout = "_Layout";
}

<div class="max-w-6xl mx-auto p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">File Manager</h1>
        <div class="flex gap-2">
            <button id="uploadImageBtn" class="btn btn-primary">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Upload Image
            </button>
            <button id="uploadFileBtn" class="btn btn-secondary">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Upload File
            </button>
        </div>
    </div>

    <!-- Storage Info Card -->
    <div class="card bg-base-100 shadow-md mb-6">
        <div class="card-body">
            <h3 class="card-title text-lg">Storage Usage</h3>
            <div class="flex items-center gap-4">
                <div class="flex-1">
                    <div class="flex justify-between mb-2">
                        <span class="text-sm font-medium">Used: <span id="usedMb">0</span> MB / <span id="maxMb">50</span> MB</span>
                        <span class="text-sm text-gray-500" id="fileCount">0 files</span>
                    </div>
                    <progress id="storageProgress" class="progress progress-primary w-full" value="0" max="100"></progress>
                </div>
            </div>
        </div>
    </div>

    <!-- Files List -->
    <div class="card bg-base-100 shadow-md">
        <div class="card-body">
            <h3 class="card-title text-lg mb-4">Files</h3>
            
            <div id="filesList" class="space-y-2">
                <div class="text-center py-8 text-gray-500">
                    Loading files...
                </div>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="flex justify-center gap-2 mt-6"></div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<dialog id="uploadModal" class="modal">
    <form id="uploadForm" class="modal-box">
        <h3 class="font-bold text-lg mb-4" id="uploadModalTitle">Upload File</h3>
        
        <div class="form-control mb-4">
            <label class="label">
                <span class="label-text">Select File</span>
            </label>
            <input type="file" id="fileInput" class="file-input file-input-bordered w-full" />
            <p class="text-sm text-gray-500 mt-2">Max size: <span id="maxSize">50MB</span></p>
        </div>

        <div class="form-control mb-4" id="categoryDiv" style="display: none;">
            <label class="label">
                <span class="label-text">Category</span>
            </label>
            <select id="category" class="select select-bordered w-full">
                <option value="document">Document</option>
                <option value="attachment">Attachment</option>
                <option value="screenshot">Screenshot</option>
                <option value="diagram">Diagram</option>
            </select>
        </div>

        <div id="uploadProgress" class="hidden">
            <progress id="progressBar" class="progress progress-primary w-full"></progress>
            <p id="progressText" class="text-sm text-center mt-2">0%</p>
        </div>

        <div class="modal-action">
            <button type="button" class="btn" onclick="uploadModal.close()">Cancel</button>
            <button type="submit" class="btn btn-primary" id="uploadSubmitBtn">Upload</button>
        </div>
    </form>
</dialog>

<style>
    .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
        transition: background-color 0.2s;
    }

    .file-item:hover {
        background-color: #f3f4f6;
    }

    .file-icon {
        width: 2.5rem;
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #dbeafe;
        border-radius: 0.25rem;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .file-item.image .file-icon {
        background: #dcfce7;
    }

    .file-info {
        flex: 1;
        min-width: 0;
    }

    .file-name {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 0.25rem;
    }

    .file-meta {
        font-size: 0.875rem;
        color: #6b7280;
    }

    .file-actions {
        display: flex;
        gap: 0.5rem;
        margin-left: 1rem;
    }

    .file-actions button {
        padding: 0.5rem;
        border: none;
        background: none;
        cursor: pointer;
        color: #6b7280;
        border-radius: 0.25rem;
        transition: background-color 0.2s;
    }

    .file-actions button:hover {
        background-color: #e5e7eb;
        color: #374151;
    }
</style>

<script>
const WORKSPACE_ID = @Model.WorkspaceId;
const uploadModal = document.getElementById('uploadModal');
const fileInput = document.getElementById('fileInput');
const uploadForm = document.getElementById('uploadForm');
const uploadImageBtn = document.getElementById('uploadImageBtn');
const uploadFileBtn = document.getElementById('uploadFileBtn');
const categoryDiv = document.getElementById('categoryDiv');
const uploadModalTitle = document.getElementById('uploadModalTitle');
const maxSizeSpan = document.getElementById('maxSize');
let currentUploadType = 'file';

uploadImageBtn.addEventListener('click', () => {
    currentUploadType = 'image';
    uploadModalTitle.textContent = 'Upload Image';
    fileInput.accept = 'image/*';
    maxSizeSpan.textContent = '10MB';
    categoryDiv.style.display = 'block';
    uploadModal.showModal();
});

uploadFileBtn.addEventListener('click', () => {
    currentUploadType = 'file';
    uploadModalTitle.textContent = 'Upload File';
    fileInput.accept = '*';
    maxSizeSpan.textContent = '50MB';
    categoryDiv.style.display = 'none';
    uploadModal.showModal();
});

uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const file = fileInput.files[0];
    if (!file) {
        alert('Please select a file');
        return;
    }

    const endpoint = currentUploadType === 'image' 
        ? `/api/files/upload-image/${WORKSPACE_ID}`
        : `/api/files/upload/${WORKSPACE_ID}`;

    const formData = new FormData();
    formData.append('file', file);
    if (currentUploadType === 'image') {
        formData.append('image', file);
        formData.append('category', document.getElementById('category').value);
    }

    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const submitBtn = document.getElementById('uploadSubmitBtn');

    progressDiv.classList.remove('hidden');
    submitBtn.disabled = true;

    try {
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressBar.value = percentComplete;
                progressText.textContent = Math.round(percentComplete) + '%';
            }
        });

        xhr.addEventListener('load', () => {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                alert('File uploaded successfully!');
                uploadModal.close();
                fileInput.value = '';
                progressDiv.classList.add('hidden');
                submitBtn.disabled = false;
                loadFiles();
            } else {
                const error = JSON.parse(xhr.responseText);
                alert('Error: ' + (error.message || 'Upload failed'));
                submitBtn.disabled = false;
            }
        });

        xhr.addEventListener('error', () => {
            alert('Upload failed. Please try again.');
            submitBtn.disabled = false;
        });

        xhr.open('POST', endpoint);
        xhr.setRequestHeader('Authorization', `Bearer ${localStorage.getItem('token')}`);
        xhr.send(formData);
    } catch (error) {
        alert('Error: ' + error.message);
        submitBtn.disabled = false;
    }
});

async function loadFiles(take = 20, skip = 0) {
    try {
        const response = await fetch(
            `/api/files/list/${WORKSPACE_ID}?take=${take}&skip=${skip}`,
            {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            }
        );

        if (!response.ok) throw new Error('Failed to load files');

        const data = await response.json();
        const filesList = document.getElementById('filesList');

        if (data.files.length === 0) {
            filesList.innerHTML = '<div class="text-center py-8 text-gray-500">No files uploaded yet</div>';
        } else {
            filesList.innerHTML = data.files.map(file => `
                <div class="file-item ${file.fileType === 'image' ? 'image' : ''}">
                    <div class="flex items-center flex-1 min-w-0">
                        <div class="file-icon">
                            ${file.fileType === 'image' ? 'üñºÔ∏è' : 'üìÑ'}
                        </div>
                        <div class="file-info">
                            <div class="file-name">${escapeHtml(file.fileName)}</div>
                            <div class="file-meta">
                                ${formatFileSize(file.size)} ‚Ä¢ ${file.contentType} ‚Ä¢ ${new Date(file.createdAt).toLocaleDateString()}
                            </div>
                        </div>
                    </div>
                    <div class="file-actions">
                        <a href="${file.publicUrl}" target="_blank" class="tooltip" data-tip="View">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                            </svg>
                        </a>
                        <a href="/api/files/download/${file.id}" class="tooltip" data-tip="Download">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                        </a>
                        <button onclick="deleteFile(${file.id})" class="tooltip" data-tip="Delete">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Update storage info
        const storageResponse = await fetch(
            `/api/files/storage-info/${WORKSPACE_ID}`,
            {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            }
        );
        
        if (storageResponse.ok) {
            const storage = await storageResponse.json();
            document.getElementById('usedMb').textContent = storage.usedMB;
            document.getElementById('maxMb').textContent = storage.maxMB;
            document.getElementById('fileCount').textContent = `${storage.fileCount} files`;
            const percentage = (storage.usedBytes / storage.maxBytes) * 100;
            document.getElementById('storageProgress').value = Math.min(100, percentage);
        }

        // Pagination
        const paginationDiv = document.getElementById('pagination');
        if (data.total > take) {
            const totalPages = Math.ceil(data.total / take);
            const currentPage = Math.floor(data.skip / take) + 1;
            
            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `<button class="btn btn-sm ${i === currentPage ? 'btn-primary' : ''}" 
                    onclick="loadFiles(${take}, ${(i-1) * take})">${i}</button>`;
            }
            paginationDiv.innerHTML = html;
        } else {
            paginationDiv.innerHTML = '';
        }
    } catch (error) {
        console.error('Error loading files:', error);
        document.getElementById('filesList').innerHTML = 
            `<div class="text-center py-8 text-red-500">Error loading files</div>`;
    }
}

async function deleteFile(fileId) {
    if (!confirm('Are you sure you want to delete this file?')) return;

    try {
        const response = await fetch(`/api/files/${fileId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        if (!response.ok) throw new Error('Delete failed');

        alert('File deleted successfully');
        loadFiles();
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load files on page load
loadFiles();
</script>
