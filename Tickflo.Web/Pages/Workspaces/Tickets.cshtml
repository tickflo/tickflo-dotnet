@page "/workspaces/{slug}/tickets"
@model Tickflo.Web.Pages.Workspaces.TicketsModel
@{
    ViewData["Title"] = "Tickets";
}

<div class="flex flex-row gap-4">
    @await Html.PartialAsync("_WorkspaceSidebar", Model.WorkspaceSlug)
    <section class="relative overflow-hidden p-6 flex-1 space-y-8 text-slate-100 rounded-3xl bg-gradient-to-br from-[#0c1220] via-[#0b101b] to-[#0a0f18]">
@await Html.PartialAsync("_WorkspaceHeader", new Tickflo.Web.Pages.Shared.WorkspaceHeaderView { Slug = Model.WorkspaceSlug, Name = Model.Workspace?.Name ?? "Workspace", SectionTitle = "Tickets", NewActionLabel = "New Ticket", NewActionHref = $"/workspaces/{Model.WorkspaceSlug}/tickets/0", AllowNewAction = Model.CanCreateTickets })

<div class="grid gap-4">
    <div class="card bg-neutral-900/70 backdrop-blur rounded-2xl border border-white/5">
        <div class="card-body p-4 flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
            <div class="space-y-1">
                <div class="text-sm uppercase tracking-wide text-white/60">Tickets</div>
                <div class="text-2xl font-semibold text-white">Keep work moving with clear tickets</div>
                <p class="text-sm text-white/70 max-w-3xl">Search, filter, and assign tickets quickly. Use the quick filters below or open the filters panel for detailed criteria.</p>
            </div>
            @{
                var chipBase = $"Query={Model.Query}&Type={Model.Type}&Priority={Model.Priority}&ContactQuery={Model.ContactQuery}&Mine={Model.Mine}&AssigneeUserId={Model.AssigneeUserId}&AssigneeTeamName={Model.AssigneeTeamName}&LocationId={Model.LocationId}&PageNumber=1&PageSize={Model.PageSize}";
                var openStatusName = "Open";
                var closedStatusName = "Closed";
            }
            <div class="flex flex-wrap gap-2">
                <a class="btn btn-sm btn-ghost border border-white/10 @(string.IsNullOrWhiteSpace(Model.Status) ? "btn-active" : string.Empty)" href="?@chipBase&Status=">All</a>
                <a class="btn btn-sm btn-ghost border border-white/10 @(string.Equals(Model.Status, openStatusName, StringComparison.OrdinalIgnoreCase) ? "btn-active" : string.Empty)" href="?@chipBase&Status=@openStatusName">Open</a>
                <a class="btn btn-sm btn-ghost border border-white/10 @(string.Equals(Model.Status, closedStatusName, StringComparison.OrdinalIgnoreCase) ? "btn-active" : string.Empty)" href="?@chipBase&Status=@closedStatusName">Closed</a>
                <a class="btn btn-sm btn-ghost border border-white/10 @((Model.AssigneeUserId.HasValue && Model.AssigneeUserId.Value == -1) ? "btn-active" : string.Empty)" href="?@chipBase&AssigneeUserId=-1">Unassigned</a>
                <a class="btn btn-sm btn-ghost border border-white/10 @(Model.Mine ? "btn-active" : string.Empty)" href="?@chipBase&Mine=true">Mine</a>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card bg-neutral-900/60 backdrop-blur rounded-2xl border border-white/5">
        <div class="card-body p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i class="fa fa-filter opacity-70"></i>
                    <span>Filters</span>
                    @{
                        var activeFilters = new List<string>();
                        if (!string.IsNullOrEmpty(Model.Query)) activeFilters.Add("Search");
                        if (!string.IsNullOrEmpty(Model.Type)) activeFilters.Add("Type");
                        if (!string.IsNullOrEmpty(Model.Status)) activeFilters.Add("Status");
                        if (!string.IsNullOrEmpty(Model.Priority)) activeFilters.Add("Priority");
                        if (!string.IsNullOrEmpty(Model.AssigneeTeamName)) activeFilters.Add("Team");
                        if (Model.LocationId.HasValue) activeFilters.Add("Location");
                        if (!string.IsNullOrEmpty(Model.ContactQuery)) activeFilters.Add("Contact");
                        if (Model.AssigneeUserId.HasValue) activeFilters.Add("Assignee");
                        if (Model.Mine) activeFilters.Add("Mine");
                    }
                    @if (activeFilters.Count > 0)
                    {
                        <span class="badge badge-primary badge-sm rounded-full">@activeFilters.Count active</span>
                    }
                </h3>
                <button type="button" class="btn btn-ghost btn-sm" onclick="document.getElementById('filter-panel').classList.toggle('hidden')">
                    <i class="fa fa-chevron-down" id="filter-chevron"></i>
                </button>
            </div>
            
            <div id="filter-panel" class="space-y-4">
                <form method="get" class="space-y-4">
                    <!-- Primary Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <div>
                            <label class="label label-text text-xs opacity-70 mb-1">Search</label>
                            <input name="Query" value="@Model.Query" placeholder="Search subject or description..." class="input input-sm w-full bg-neutral-900/80 border border-white/10 text-slate-100" />
                        </div>
                        <div>
                            <label class="label label-text text-xs opacity-70 mb-1">Status</label>
                            <select name="Status" class="select select-sm w-full bg-neutral-900/80 border border-white/10 text-slate-100">
                                <option value="">All Statuses</option>
                                @foreach (var s in Model.Statuses)
                                {
                                    @if (string.Equals(Model.Status, s.Name, StringComparison.OrdinalIgnoreCase))
                                    {
                                        <option value="@s.Name" selected>@s.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@s.Name">@s.Name</option>
                                    }
                                }
                            </select>
                        </div>
                        <div>
                            <label class="label label-text text-xs opacity-70 mb-1">Priority</label>
                            <select name="Priority" class="select select-sm w-full bg-neutral-900/80 border border-white/10 text-slate-100">
                                <option value="">All Priorities</option>
                                @foreach (var p in Model.PrioritiesList)
                                {
                                    @if (string.Equals(Model.Priority, p.Name, StringComparison.OrdinalIgnoreCase))
                                    {
                                        <option value="@p.Name" selected>@p.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@p.Name">@p.Name</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>

                    <!-- Secondary Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <div>
                            <label class="label label-text text-xs opacity-70 mb-1">Type</label>
                            <select name="Type" class="select select-sm w-full bg-neutral-900/80 border border-white/10 text-slate-100">
                                <option value="">All Types</option>
                                @foreach (var t in Model.TypesList)
                                {
                                    @if (string.Equals(Model.Type, t.Name, StringComparison.OrdinalIgnoreCase))
                                    {
                                        <option value="@t.Name" selected>@t.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@t.Name">@t.Name</option>
                                    }
                                }
                            </select>
                        </div>
                        <div>
                            <label class="label label-text text-xs opacity-70 mb-1">Assignee</label>
                            <select name="AssigneeUserId" class="select select-sm w-full bg-neutral-900/80 border border-white/10 text-slate-100">
                                <option value="">Anyone</option>
                                @if (Model.AssigneeUserId == -1)
                                {
                                    <option value="-1" selected>Unassigned</option>
                                }
                                else
                                {
                                    <option value="-1">Unassigned</option>
                                }
                                @foreach (var kv in Model.UsersById)
                                {
                                    @if (Model.AssigneeUserId == kv.Key)
                                    {
                                        <option value="@kv.Key" selected>@kv.Value.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@kv.Key">@kv.Value.Name</option>
                                    }
                                }
                            </select>
                        </div>
                        <div>
                            <label class="label label-text text-xs opacity-70 mb-1">Team</label>
                            <select name="AssigneeTeamName" class="select select-sm w-full bg-neutral-900/80 border border-white/10 text-slate-100">
                                <option value="">Any Team</option>
                                @foreach (var kv in Model.TeamsById)
                                {
                                    @if (string.Equals(Model.AssigneeTeamName, kv.Value.Name, StringComparison.OrdinalIgnoreCase))
                                    {
                                        <option value="@kv.Value.Name" selected>@kv.Value.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@kv.Value.Name">@kv.Value.Name</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>

                    <!-- Additional Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="label label-text text-xs opacity-70 mb-1">Contact</label>
                            <input id="contact-query" name="ContactQuery" value="@Model.ContactQuery" placeholder="Contact name or email..." class="input input-sm w-full bg-neutral-900/80 border border-white/10 text-slate-100" list="contacts-list" />
                            <datalist id="contacts-list">
                                @foreach (var kv in Model.ContactsById)
                                {
                                    var c = kv.Value;
                                    var label = (c.Email?.Length ?? 0) > 0 ? $"{c.Name} ({c.Email})" : c.Name;
                                    <option value="@label"></option>
                                }
                            </datalist>
                        </div>
                        <div>
                            <label class="label label-text text-xs opacity-70 mb-1">Location</label>
                            <select name="LocationId" class="select select-sm w-full bg-neutral-900/80 border border-white/10 text-slate-100">
                                <option value="">Any Location</option>
                                @foreach (var l in Model.LocationOptions)
                                {
                                    @if (Model.LocationId.HasValue && Model.LocationId.Value == l.Id)
                                    {
                                        <option value="@l.Id" selected>@l.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@l.Id">@l.Name</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex items-center justify-between pt-2 border-t border-white/10">
                        <label class="label cursor-pointer gap-2">
                            <input type="checkbox" name="Mine" value="true" class="checkbox checkbox-sm checkbox-primary" @(Model.Mine ? "checked" : "") />
                            <span class="label-text">Show only my tickets</span>
                            <span class="badge badge-soft badge-sm rounded-full">@Model.MyCount</span>
                        </label>
                        <div class="flex gap-2">
                            <a href="/workspaces/@Model.WorkspaceSlug/tickets" class="btn btn-ghost btn-sm">Clear All</a>
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="fa fa-filter mr-1"></i> Apply Filters
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Toggle filter panel chevron
        const filterPanel = document.getElementById('filter-panel');
        const filterChevron = document.getElementById('filter-chevron');
        const observer = new MutationObserver(() => {
            if (filterPanel.classList.contains('hidden')) {
                filterChevron.classList.remove('fa-chevron-up');
                filterChevron.classList.add('fa-chevron-down');
            } else {
                filterChevron.classList.remove('fa-chevron-down');
                filterChevron.classList.add('fa-chevron-up');
            }
        });
        observer.observe(filterPanel, { attributes: true, attributeFilter: ['class'] });
    </script>

    <!-- Tickets Table -->
    <div class="card bg-neutral-900/85 backdrop-blur shadow-2xl rounded-3xl text-slate-100">
      <div class="card-body p-0">
        <div class="overflow-x-auto">
          <table class="table table-sm table-zebra align-middle min-w-[720px]">
            <thead>
                <tr class="border-b border-white/10 bg-white/5">
                    <th class="font-semibold text-xs uppercase tracking-wider opacity-90">Subject</th>
                    <th class="font-semibold text-xs uppercase tracking-wider opacity-90">Type / Priority</th>
                    <th class="font-semibold text-xs uppercase tracking-wider opacity-90">Status</th>
                    <th class="font-semibold text-xs uppercase tracking-wider opacity-90">Assignee</th>
                    <th class="font-semibold text-xs uppercase tracking-wider opacity-90">Actions</th>
                </tr>
            </thead>
            <tbody>
                        @if (!Model.Tickets.Any())
                        {
                            <tr>
                                <td colspan="5" class="text-center py-12">
                                    <div class="flex flex-col items-center gap-3 opacity-60">
                                        <i class="fa fa-ticket text-4xl"></i>
                                        <p class="text-lg">No tickets found</p>
                                        <p class="text-sm">Try adjusting your filters or create a new ticket</p>
                                    </div>
                                </td>
                            </tr>
                        }
                        @foreach (var t in Model.Tickets)
            {
                <tr class="hover:bg-white/5 transition-colors border-b border-white/5 text-sm">
                                        @{
                                            var rowQs = $"Query={Model.Query}&Type={Model.Type}&Status={Model.Status}&Priority={Model.Priority}&ContactQuery={Model.ContactQuery}&Mine={Model.Mine}&AssigneeUserId={Model.AssigneeUserId}&LocationId={Model.LocationId}&PageNumber={Model.PageNumber}&PageSize={Model.PageSize}";
                                        }
                                        <td class="py-3 align-top max-w-[260px]">
                            <div class="flex flex-col gap-1">
                                <a class="link link-hover font-semibold text-blue-300 hover:text-blue-200 truncate" title="@t.Subject" href="/workspaces/@Model.WorkspaceSlug/tickets/@t.Id?@rowQs">@t.Subject</a>
                                <div class="flex flex-wrap gap-2 text-xs text-white/60">
                                    <span class="badge badge-ghost badge-xs rounded-full">#@t.Id</span>
                                    <span>@t.CreatedAt.ToLocalTime().ToString("MMM dd, HH:mm")</span>
                                </div>
                            </div>
                        </td>
                    @{
                        var tcolor = Model.TypeColorByName.TryGetValue(t.Type, out var tclr) ? tclr : "neutral";
                        var tIsHex = tcolor.StartsWith("#");
                        var tCls = tIsHex ? "badge badge-soft rounded-full" : $"badge badge-soft badge-{tcolor} rounded-full";
                        var tStyle = tIsHex ? $"background-color: {tcolor}; color: #fff;" : null;
                    }
                                    <td class="py-3 align-top">
                                        <div class="flex flex-col gap-1">
                                            <span class="@tCls text-xs" style="@tStyle">@t.Type</span>
                                            @{
                                                var pcolor = Model.PriorityColorByName.TryGetValue(t.Priority, out var pclr) ? pclr : "neutral";
                                                var pIsHex = pcolor.StartsWith("#");
                                                var pCls = pIsHex ? "badge badge-soft rounded-full" : $"badge badge-soft badge-{pcolor} rounded-full";
                                                var pStyle = pIsHex ? $"background-color: {pcolor}; color: #fff;" : null;
                                            }
                                            <span class="@pCls text-xs font-semibold" style="@pStyle">@t.Priority</span>
                                        </div>
                                    </td>
                    @{
                        var color = Model.StatusColorByName.TryGetValue(t.Status, out var col) ? col : "neutral";
                        var isHex = color.StartsWith("#");
                        var statusCls = isHex ? "badge badge-soft rounded-full" : $"badge badge-soft badge-{color} rounded-full";
                        var statusStyle = isHex ? $"background-color: {color}; color: #fff;" : null;
                    }
                    <td class="py-3 align-top"><span class="@statusCls text-xs font-semibold" style="@statusStyle">@t.Status</span></td>
                                            <td class="py-3 align-top">
                        @if (t.AssignedTeamId.HasValue && Model.TeamsById.TryGetValue(t.AssignedTeamId.Value, out var team))
                        {
                            <span class="badge badge-info badge-soft rounded-full text-xs"><i class="fa fa-users mr-1"></i>@team.Name</span>
                        }
                        else if (t.AssignedUserId.HasValue && Model.UsersById.TryGetValue(t.AssignedUserId.Value, out var au))
                        {
                            <div class="flex flex-col">
                                <span class="badge badge-soft rounded-full text-xs"><i class="fa fa-user mr-1"></i>@au.Name</span>
                            </div>
                        }
                        else
                        {
                            <span class="badge badge-ghost badge-sm rounded-full opacity-50">Unassigned</span>
                        }
                    </td>
                    <td class="py-3 align-top">
                        <div class="flex flex-col gap-2">
                            <div class="flex gap-1 flex-wrap">
                                @if (Model.CanCreateTickets)
                                {
                                    <a class="btn btn-ghost btn-xs" href="/workspaces/@Model.WorkspaceSlug/tickets/0@(t.ContactId.HasValue ? ($"?contactId={t.ContactId}") : string.Empty)" title="Clone ticket">
                                        <i class="fa fa-copy"></i>
                                    </a>
                                }
                                <a class="btn btn-primary btn-xs" href="/workspaces/@Model.WorkspaceSlug/tickets/@t.Id?@rowQs" title="View details">
                                    <i class="fa fa-eye"></i>
                                </a>
                            </div>
                            <form method="post" action="/workspaces/@Model.WorkspaceSlug/tickets/@t.Id?@rowQs" class="flex gap-1 ajax-assign" data-ticket-id="@t.Id">
                                <input type="hidden" name="handler" value="Assign" />
                                <input type="hidden" name="slug" value="@Model.WorkspaceSlug" />
                                <input type="hidden" name="id" value="@t.Id" />
                                <input type="hidden" id="assignedUserId-@t.Id" name="assignedUserId" value="@(t.AssignedUserId?.ToString() ?? "")" />
                                <input id="assignee-search-@t.Id" class="input input-bordered input-xs w-32" list="assignees-list-@t.Id" placeholder="Assign to..." />
                                <datalist id="assignees-list-@t.Id">
                                    <option value="Unassigned" data-id=""></option>
                                    @foreach (var kv in Model.UsersById)
                                    {
                                        <option value="@kv.Value.Name" data-id="@kv.Key"></option>
                                    }
                                </datalist>
                                <button class="btn btn-primary btn-xs" type="submit" @(Model.CanEditTickets ? "" : "disabled") title="Assign ticket">
                                    <i class="fa fa-check"></i>
                                </button>
                            </form>
                            <script>
                                (function(){
                                    const hidden = document.getElementById('assignedUserId-@t.Id');
                                    const input = document.getElementById('assignee-search-@t.Id');
                                    const list = document.getElementById('assignees-list-@t.Id');
                                    if (!hidden || !input || !list) return;
                                    function setFromText(){
                                        const val = input.value;
                                        const opts = Array.from(list.querySelectorAll('option'));
                                        const matched = opts.find(o => o.value === val);
                                        if (matched) {
                                            hidden.value = matched.getAttribute('data-id') || '';
                                        } else if (val === '' || val.toLowerCase() === 'unassigned') {
                                            hidden.value = '';
                                        }
                                    }
                                    input.addEventListener('change', setFromText);
                                    input.addEventListener('blur', function(){
                                        setFromText();
                                        if ((hidden.value ?? '') === '' && (input.value === '' || input.value.toLowerCase() === 'unassigned')){
                                            input.value = 'Unassigned';
                                            input.setAttribute('placeholder', 'Pick from list');
                                        }
                                    });
                                    input.addEventListener('focus', function(){
                                        if (input.value.toLowerCase() === 'unassigned') {
                                            input.value = '';
                                        }
                                    });
                                    const preset = hidden.value ?? '';
                                    if (preset !== ''){
                                        const opt = Array.from(list.querySelectorAll('option')).find(o => o.getAttribute('data-id') === preset);
                                        if (opt) input.value = opt.value; else input.value = '';
                                    } else {
                                        input.value = 'Unassigned';
                                    }
                                })();
                            </script>
                        </div>
                    </td>
                </tr>
            }
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="toast" id="assign-toast" style="display:none;">
        <div class="alert alert-success">
            <span id="assign-toast-msg">Assignment updated.</span>
        </div>
    </div>
    <div class="toast" id="assign-error-toast" style="display:none;">
        <div class="alert alert-error">
            <span id="assign-error-toast-msg">Assignment failed.</span>
        </div>
    </div>
    <script>
        (function(){
            @{ var statusDict = new System.Collections.Generic.Dictionary<string, string>();
               foreach (var s in Model.Statuses)
               {
                 var key = s.Name ?? string.Empty;
                 var val = string.IsNullOrWhiteSpace(s.Color) ? "neutral" : s.Color!;
                 statusDict[key] = val;
               }
               var priorityDict = new System.Collections.Generic.Dictionary<string, string>();
               foreach (var p in Model.PrioritiesList)
               {
                 var key = p.Name ?? string.Empty;
                 var val = string.IsNullOrWhiteSpace(p.Color) ? "neutral" : p.Color!;
                 priorityDict[key] = val;
               }
               var typeDict = new System.Collections.Generic.Dictionary<string, string>();
               foreach (var tt in Model.TypesList)
               {
                 var key = tt.Name ?? string.Empty;
                 var val = string.IsNullOrWhiteSpace(tt.Color) ? "neutral" : tt.Color!;
                 typeDict[key] = val;
               }
               var statusJson = System.Text.Json.JsonSerializer.Serialize(statusDict);
               var priorityJson = System.Text.Json.JsonSerializer.Serialize(priorityDict);
               var typeJson = System.Text.Json.JsonSerializer.Serialize(typeDict);
            }
            const statusColors = @Html.Raw(statusJson);
            const priorityColors = @Html.Raw(priorityJson);
            const typeColors = @Html.Raw(typeJson);
            // Minimal fade-in animation style for newly inserted rows
            const style = document.createElement('style');
            style.textContent = ".fade-in { animation: fadeIn 450ms ease-out; }\n@keyframes fadeIn { from { opacity: 0; transform: translateY(-2px); } to { opacity: 1; transform: translateY(0); } }";
            document.head.appendChild(style);
            async function handleAssignSubmit(e){
                e.preventDefault();
                const form = e.currentTarget;
                const ticketId = form.getAttribute('data-ticket-id');
                const input = document.getElementById('assignee-search-' + ticketId);
                const hidden = document.getElementById('assignedUserId-' + ticketId);
                if (!hidden) return;
                const action = form.getAttribute('action');
                const fd = new FormData(form);
                const btn = form.querySelector('button[type="submit"]');
                try {
                    if (btn){ btn.disabled = true; btn.classList.add('btn-disabled'); }
                    const res = await fetch(action, { method: 'POST', body: fd, credentials: 'same-origin' });
                    if (res.ok){
                        const toast = document.getElementById('assign-toast');
                        const msg = document.getElementById('assign-toast-msg');
                        if (toast && msg){
                            const nameTxt = (input && input.value) ? input.value : (hidden.value ? 'Assigned' : 'Unassigned');
                            msg.textContent = `Ticket #${ticketId} assigned: ${nameTxt}`;
                            toast.style.display = '';
                            setTimeout(()=>{ toast.style.display = 'none'; }, 2500);
                        }
                        const badgeCell = form.closest('tr')?.querySelector('td:nth-child(4)');
                        if (badgeCell){
                            if (hidden.value){
                                badgeCell.innerHTML = `<span class="badge badge-soft rounded-full">${input.value}</span>`;
                            } else {
                                badgeCell.innerHTML = `<span class="badge">Unassigned</span>`;
                            }
                        }
                    } else {
                        const toast = document.getElementById('assign-error-toast');
                        const msg = document.getElementById('assign-error-toast-msg');
                        if (toast && msg){
                            msg.textContent = `Assign failed (status ${res.status}).`;
                            toast.style.display = '';
                            setTimeout(()=>{ toast.style.display = 'none'; }, 3000);
                        }
                        console.error('Assign failed', res.status);
                    }
                } catch(err){
                    const toast = document.getElementById('assign-error-toast');
                    const msg = document.getElementById('assign-error-toast-msg');
                    if (toast && msg){
                        msg.textContent = 'Assign error. Please try again.';
                        toast.style.display = '';
                        setTimeout(()=>{ toast.style.display = 'none'; }, 3000);
                    }
                    console.error('Assign error', err);
                } finally {
                    if (btn){ btn.disabled = false; btn.classList.remove('btn-disabled'); }
                }
            }
            document.querySelectorAll('form.ajax-assign').forEach(f => {
                f.addEventListener('submit', handleAssignSubmit);
            });
            // Live updates: connect SignalR and join workspace group
            const slug = '@Model.WorkspaceSlug';
            try {
                const connection = new signalR.HubConnectionBuilder()
                    .withUrl('/hubs/tickets')
                    .withAutomaticReconnect()
                    .build();
                connection.on('ticketCreated', function(t){
                    const tbody = document.querySelector('table tbody');
                    if (!tbody) return;
                    const tr = document.createElement('tr');
                    tr.classList.add('fade-in');
                    const rowQs = `Query=@Model.Query&Status=@Model.Status&Priority=@Model.Priority&ContactQuery=@Model.ContactQuery&Mine=@Model.Mine&AssigneeUserId=@Model.AssigneeUserId&PageNumber=@Model.PageNumber&PageSize=@Model.PageSize`;
                    const color = statusColors[t.status] || 'neutral';
                    const isHex = (typeof color === 'string') && color.startsWith('#');
                    const statusSpan = isHex
                            ? `<span class="badge" style="background-color: ${color}; color: #fff;">${t.status}</span>`
                            : `<span class="badge badge-soft badge-${color} rounded-full">${t.status}</span>`;
                    const tc = typeColors[t.type] || 'neutral';
                    const tIsHex = (typeof tc === 'string') && tc.startsWith('#');
                    const typeSpan = tIsHex ? `<span class="badge badge-soft rounded-full" style="background-color: ${tc}; color: #fff;">${t.type}</span>` : `<span class="badge badge-soft badge-${tc} rounded-full">${t.type}</span>`;
                    const pc = priorityColors[t.priority] || 'neutral';
                    const pIsHex = (typeof pc === 'string') && pc.startsWith('#');
                    const prioSpan = pIsHex ? `<span class="badge badge-soft rounded-full" style="background-color: ${pc}; color: #fff;">${t.priority}</span>` : `<span class="badge badge-soft badge-${pc} rounded-full">${t.priority}</span>`;
                    const created = new Date(t.createdAt).toLocaleString();
                    tr.innerHTML = `
                        <td><div class="flex flex-col gap-1"><a class="link link-hover" href="/workspaces/${slug}/tickets/${t.id}?${rowQs}">${t.subject}</a><div class="flex flex-wrap gap-2 text-xs text-white/60"><span class="badge badge-ghost badge-xs rounded-full">#${t.id}</span><span>${created}</span></div></div></td>
                        <td><div class="flex flex-col gap-1">${typeSpan}${prioSpan}</div></td>
                        <td>${statusSpan}</td>
                        <td><span class="badge ${t.assignedUserId ? 'badge-soft' : 'badge-ghost'} rounded-full">${t.assignedUserId ? (t.assignedDisplay || 'Assigned') : 'Unassigned'}</span></td>
                        <td><a class="btn btn-primary btn-xs" href="/workspaces/${slug}/tickets/${t.id}?${rowQs}"><i class="fa fa-eye"></i></a></td>`;
                    tbody.insertBefore(tr, tbody.firstChild);
                });
                connection.on('ticketUpdated', function(t){
                    const row = document.querySelector(`tr td a[href^="/workspaces/${slug}/tickets/${t.id}"]`)?.closest('tr');
                    if (row){
                        const subjectCell = row.querySelector('td:nth-child(1) a');
                        const typePriCell = row.querySelector('td:nth-child(2)');
                        const statusCell = row.querySelector('td:nth-child(3) .badge');
                        if (subjectCell) subjectCell.textContent = t.subject;
                        if (typePriCell){
                            const tc = typeColors[t.type] || 'neutral';
                            const tIsHex = (typeof tc === 'string') && tc.startsWith('#');
                            const typeSpan = tIsHex ? `<span class="badge badge-soft rounded-full" style="background-color: ${tc}; color: #fff;">${t.type}</span>` : `<span class="badge badge-soft badge-${tc} rounded-full">${t.type}</span>`;
                            const pc = priorityColors[t.priority] || 'neutral';
                            const pIsHex = (typeof pc === 'string') && pc.startsWith('#');
                            const prioSpan = pIsHex ? `<span class="badge badge-soft rounded-full" style="background-color: ${pc}; color: #fff;">${t.priority}</span>` : `<span class="badge badge-soft badge-${pc} rounded-full">${t.priority}</span>`;
                            typePriCell.innerHTML = `<div class="flex flex-col gap-1">${typeSpan}${prioSpan}</div>`;
                        }
                        if (statusCell) {
                            statusCell.textContent = t.status;
                            const c = statusColors[t.status] || 'neutral';
                            if ((typeof c === 'string') && c.startsWith('#')) {
                                statusCell.className = 'badge badge-soft rounded-full';
                                statusCell.setAttribute('style', `background-color: ${c}; color: #fff;`);
                            } else {
                                statusCell.className = `badge badge-soft badge-${c} rounded-full`;
                                statusCell.removeAttribute('style');
                            }
                        }
                    }
                });
                connection.on('ticketAssigned', function(t){
                    const row = document.querySelector(`tr td a[href^="/workspaces/${slug}/tickets/${t.id}"]`)?.closest('tr');
                    if (!row) return;
                    const assigneeCell = row.querySelector('td:nth-child(4)');
                    if (!assigneeCell) return;
                    if (t.assignedUserId){
                        const label = t.assignedDisplay || 'Assigned';
                        assigneeCell.innerHTML = `<span class="badge badge-soft rounded-full">${label}</span>`;
                    } else {
                        assigneeCell.innerHTML = `<span class="badge">Unassigned</span>`;
                    }
                });
                await connection.start();
                await connection.invoke('JoinWorkspace', slug);
            } catch (err) {
                console.warn('SignalR connection failed', err);
            }
        })();
    </script>

    <!-- Pagination -->
    <div class="card bg-neutral-900/60 backdrop-blur rounded-2xl">
        <div class="card-body p-4">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-3">
                <div class="flex flex-col sm:flex-row items-center gap-3">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium">@Model.Total tickets total</span>
                        <span class="hidden sm:inline opacity-50">Â·</span>
                        <span class="text-sm opacity-70">Page @Model.PageNumber of @((Model.Total + Model.PageSize - 1)/Model.PageSize)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm opacity-70">Show:</label>
                        <select id="page-size-select" class="select select-sm bg-neutral-900/80 border border-white/10 text-slate-100" onchange="window.location.href = this.value">
                            @{
                                var pageSizeQs = $"Query={Model.Query}&Type={Model.Type}&Status={Model.Status}&Priority={Model.Priority}&ContactQuery={Model.ContactQuery}&Mine={Model.Mine}&AssigneeUserId={Model.AssigneeUserId}&LocationId={Model.LocationId}&PageNumber=1";
                                var pageSizes = new[] { 10, 25, 50, 100 };
                            }
                            @foreach (var size in pageSizes)
                            {
                                @if (Model.PageSize == size)
                                {
                                    <option value="?@pageSizeQs&PageSize=@size" selected>@size rows</option>
                                }
                                else
                                {
                                    <option value="?@pageSizeQs&PageSize=@size">@size rows</option>
                                }
                            }
                        </select>
                    </div>
                </div>
                <div class="join">
                    @{
                        var prev = Model.PageNumber > 1 ? Model.PageNumber - 1 : 1;
                        var next = (Model.PageNumber * Model.PageSize) < Model.Total ? Model.PageNumber + 1 : Model.PageNumber;
                        var baseQs = $"Query={Model.Query}&Type={Model.Type}&Status={Model.Status}&Priority={Model.Priority}&ContactQuery={Model.ContactQuery}&Mine={Model.Mine}&AssigneeUserId={Model.AssigneeUserId}&LocationId={Model.LocationId}&PageSize={Model.PageSize}";
                        var totalPages = (Model.Total + Model.PageSize - 1) / Model.PageSize;
                    }
                    <a class="btn btn-soft join-item btn-sm @(Model.PageNumber <= 1 ? "btn-disabled" : "")" href="?@baseQs&PageNumber=@prev">
                        <i class="fa fa-chevron-left"></i> Previous
                    </a>
                    <button class="btn btn-soft join-item btn-sm" disabled>
                        @Model.PageNumber / @totalPages
                    </button>
                    <a class="btn btn-soft join-item btn-sm @(((Model.PageNumber * Model.PageSize) >= Model.Total) ? "btn-disabled" : "")" href="?@baseQs&PageNumber=@next">
                        Next <i class="fa fa-chevron-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    </div>
    </section>
</div>
