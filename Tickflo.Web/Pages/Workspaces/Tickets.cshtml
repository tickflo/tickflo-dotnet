@page "/workspaces/{slug}/tickets"
@model Tickflo.Web.Pages.Workspaces.TicketsModel
@{
    ViewData["Title"] = "Tickets";
}

<div class="flex flex-row gap-10">
    @await Html.PartialAsync("_WorkspaceSidebar", Model.WorkspaceSlug)
    <section class="p-8 lg:p-10 flex-1 ml-6">
@await Html.PartialAsync("_WorkspaceHeader", new Tickflo.Web.Pages.Shared.WorkspaceHeaderView { Slug = Model.WorkspaceSlug, Name = Model.Workspace?.Name ?? "Workspace", SectionTitle = "Tickets", NewActionLabel = "New Ticket", NewActionHref = $"/workspaces/{Model.WorkspaceSlug}/tickets/new" })

<div class="grid gap-4">
    <div class="flex items-center justify-between">
        <form method="get" class="join md:join">
            <input name="Query" value="@Model.Query" placeholder="Search subject or description" class="input input-bordered join-item input-sm md:input-md" />
            <select name="Status" class="select select-bordered join-item select-sm md:select-md">
                <option value="">All Statuses</option>
                @foreach (var s in Model.Statuses)
                {
                    if (string.Equals(Model.Status, s.Name, StringComparison.OrdinalIgnoreCase))
                    {
                        <option value="@s.Name" selected>@s.Name</option>
                    }
                    else
                    {
                        <option value="@s.Name">@s.Name</option>
                    }
                }
            </select>
            <select name="Priority" class="select select-bordered join-item select-sm md:select-md">
                <option value="">All Priorities</option>
                @foreach (var p in Model.PrioritiesList)
                {
                    if (string.Equals(Model.Priority, p.Name, StringComparison.OrdinalIgnoreCase))
                    {
                        <option value="@p.Name" selected>@p.Name</option>
                    }
                    else
                    {
                        <option value="@p.Name">@p.Name</option>
                    }
                }
            </select>
            <input name="ContactId" value="@Model.ContactId" type="number" placeholder="Contact Id" class="input input-bordered join-item input-sm md:input-md" />
            <select name="AssigneeUserId" class="select select-bordered join-item select-sm md:select-md">
                <option value="">Anyone</option>
                @if (Model.AssigneeUserId == -1) {<option value="-1" selected>Unassigned</option>} else {<option value="-1">Unassigned</option>}
                @foreach (var kv in Model.UsersById)
                {
                    if (Model.AssigneeUserId == kv.Key)
                    {
                        <option value="@kv.Key" selected>@kv.Value.Name (@kv.Value.Email)</option>
                    }
                    else
                    {
                        <option value="@kv.Key">@kv.Value.Name (@kv.Value.Email)</option>
                    }
                }
            </select>
            <label class="label cursor-pointer join-item px-3">
                <span class="label-text mr-2">Mine</span>
                <input type="checkbox" name="Mine" value="true" class="checkbox checkbox-sm" @(Model.Mine ? "checked" : "") />
                <span class="badge badge-soft ml-2">@Model.MyCount</span>
            </label>
            <button class="btn btn-soft join-item btn-sm md:btn-md">Filter</button>
        </form>
    </div>

    <div class="overflow-x-auto pl-6">
        <table class="table table-zebra table-md">
            <thead>
                <tr>
                    <th>Subject</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Contact</th>
                    <th class="hidden sm:table-cell">Assignee</th>
                    <th class="hidden sm:table-cell">Inventory</th>
                    <th class="hidden md:table-cell">Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                        @foreach (var t in Model.Tickets)
            {
                <tr>
                                        @{
                                            var rowQs = $"Query={Model.Query}&Status={Model.Status}&Priority={Model.Priority}&ContactId={Model.ContactId}&Mine={Model.Mine}&AssigneeUserId={Model.AssigneeUserId}&PageNumber={Model.PageNumber}&PageSize={Model.PageSize}";
                                        }
                                        <td><a class="link link-hover" href="/workspaces/@Model.WorkspaceSlug/tickets/@t.Id?@rowQs">@t.Subject</a></td>
                    @{
                        var pcolor = Model.PriorityColorByName.TryGetValue(t.Priority, out var pclr) ? pclr : "neutral";
                        var pIsHex = pcolor.StartsWith("#");
                        var pCls = pIsHex ? "badge badge-soft" : $"badge badge-soft badge-{pcolor}";
                        var pStyle = pIsHex ? $"background-color: {pcolor}; color: #fff;" : null;
                    }
                    <td><span class="@pCls" style="@pStyle">@t.Priority</span></td>
                    @{
                        var color = Model.StatusColorByName.TryGetValue(t.Status, out var col) ? col : "neutral";
                        var isHex = color.StartsWith("#");
                        var statusCls = isHex ? "badge badge-soft" : $"badge badge-soft badge-{color}";
                        var statusStyle = isHex ? $"background-color: {color}; color: #fff;" : null;
                    }
                    <td><span class="@statusCls" style="@statusStyle">@t.Status</span></td>
                        <td>
                        @if (t.ContactId.HasValue && Model.ContactsById.TryGetValue(t.ContactId.Value, out var c))
                        {
                            <span>@c.Name</span>
                            <span class="opacity-60 break-all">(@c.Email)</span>
                        }
                        else
                        {
                                <span class="opacity-60">—</span>
                        }
                    </td>
                        <td class="hidden sm:table-cell">
                        @if (t.AssignedUserId.HasValue && Model.UsersById.TryGetValue(t.AssignedUserId.Value, out var au))
                        {
                            <span class="badge badge-soft">@au.Name</span>
                            <span class="opacity-60 ml-2">(@au.Email)</span>
                        }
                        else
                        {
                            <span class="badge">Unassigned</span>
                        }
                    </td>
                        <td>
                        @if (!string.IsNullOrWhiteSpace(t.InventoryRef))
                        {
                                <a class="link link-hover" href="/workspaces/@Model.WorkspaceSlug/inventory?Query=@t.InventoryRef">@t.InventoryRef</a>
                        }
                        else
                        {
                                <span class="opacity-50">—</span>
                        }
                    </td>
                        <td class="hidden md:table-cell">@t.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                    <td>
                        <div class="flex flex-wrap gap-2 items-center">
                            <a class="btn btn-soft btn-sm" href="/workspaces/@Model.WorkspaceSlug/tickets/new@(t.ContactId.HasValue ? ($"?contactId={t.ContactId}") : string.Empty)">Clone</a>
                            <form method="post" action="/workspaces/@Model.WorkspaceSlug/tickets/@t.Id?@rowQs" class="join ajax-assign" data-ticket-id="@t.Id">
                                <input type="hidden" name="handler" value="Assign" />
                                <input type="hidden" name="slug" value="@Model.WorkspaceSlug" />
                                <input type="hidden" name="id" value="@t.Id" />
                                <input type="hidden" id="assignedUserId-@t.Id" name="assignedUserId" value="@(t.AssignedUserId?.ToString() ?? "")" />
                                <input id="assignee-search-@t.Id" class="input input-bordered join-item input-xs md:input-sm" list="assignees-list-@t.Id" placeholder="Assign" />
                                <datalist id="assignees-list-@t.Id">
                                    <option value="Unassigned" data-id=""></option>
                                    @foreach (var kv in Model.UsersById)
                                    {
                                        <option value="@kv.Value.Name (@kv.Value.Email)" data-id="@kv.Key"></option>
                                    }
                                </datalist>
                                                            <button class="btn btn-soft join-item btn-xs md:btn-sm" type="submit">Assign</button>
                            </form>
                            <script>
                                (function(){
                                    const hidden = document.getElementById('assignedUserId-@t.Id');
                                    const input = document.getElementById('assignee-search-@t.Id');
                                    const list = document.getElementById('assignees-list-@t.Id');
                                    if (!hidden || !input || !list) return;
                                    function setFromText(){
                                        const val = input.value;
                                        const opts = Array.from(list.querySelectorAll('option'));
                                        const matched = opts.find(o => o.value === val);
                                        if (matched) {
                                            hidden.value = matched.getAttribute('data-id') || '';
                                        } else if (val === '' || val.toLowerCase() === 'unassigned') {
                                            hidden.value = '';
                                        }
                                    }
                                    input.addEventListener('change', setFromText);
                                    input.addEventListener('blur', function(){
                                        setFromText();
                                        if ((hidden.value ?? '') === '' && (input.value === '' || input.value.toLowerCase() === 'unassigned')){
                                            input.value = 'Unassigned';
                                            input.setAttribute('placeholder', 'Pick from list');
                                        }
                                    });
                                    input.addEventListener('focus', function(){
                                        if (input.value.toLowerCase() === 'unassigned') {
                                            input.value = '';
                                        }
                                    });
                                    const preset = hidden.value ?? '';
                                    if (preset !== ''){
                                        const opt = Array.from(list.querySelectorAll('option')).find(o => o.getAttribute('data-id') === preset);
                                        if (opt) input.value = opt.value; else input.value = '';
                                    } else {
                                        input.value = 'Unassigned';
                                    }
                                })();
                            </script>
                        </div>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>

    <div class="toast" id="assign-toast" style="display:none;">
        <div class="alert alert-success">
            <span id="assign-toast-msg">Assignment updated.</span>
        </div>
    </div>
    <div class="toast" id="assign-error-toast" style="display:none;">
        <div class="alert alert-error">
            <span id="assign-error-toast-msg">Assignment failed.</span>
        </div>
    </div>
    <script>
        (function(){
            const statusColors = {
@for (int i = 0; i < Model.Statuses.Count; i++)
{
    var s = Model.Statuses[i];
        var color = string.IsNullOrWhiteSpace(s.Color) ? "neutral" : s.Color;
    @:$"\"{s.Name.Replace("\"","\\\"")}\": \"{color}\"{(i < Model.Statuses.Count - 1 ? "," : string.Empty)}"
}
            };
            const priorityColors = {
@for (int i = 0; i < Model.PrioritiesList.Count; i++)
{
    var p = Model.PrioritiesList[i];
        var color = string.IsNullOrWhiteSpace(p.Color) ? "neutral" : p.Color;
    @:$"\"{p.Name.Replace("\"","\\\"")}\": \"{color}\"{(i < Model.PrioritiesList.Count - 1 ? "," : string.Empty)}"
}
            };
            // Minimal fade-in animation style for newly inserted rows
            const style = document.createElement('style');
            style.textContent = ".fade-in { animation: fadeIn 450ms ease-out; }\n@keyframes fadeIn { from { opacity: 0; transform: translateY(-2px); } to { opacity: 1; transform: translateY(0); } }";
            document.head.appendChild(style);
            async function handleAssignSubmit(e){
                e.preventDefault();
                const form = e.currentTarget;
                const ticketId = form.getAttribute('data-ticket-id');
                const input = document.getElementById('assignee-search-' + ticketId);
                const hidden = document.getElementById('assignedUserId-' + ticketId);
                if (!hidden) return;
                const action = form.getAttribute('action');
                const fd = new FormData(form);
                const btn = form.querySelector('button[type="submit"]');
                try {
                    if (btn){ btn.disabled = true; btn.classList.add('btn-disabled'); }
                    const res = await fetch(action, { method: 'POST', body: fd, credentials: 'same-origin' });
                    if (res.ok){
                        const toast = document.getElementById('assign-toast');
                        const msg = document.getElementById('assign-toast-msg');
                        if (toast && msg){
                            const nameTxt = (input && input.value) ? input.value : (hidden.value ? 'Assigned' : 'Unassigned');
                            msg.textContent = `Ticket #${ticketId} assigned: ${nameTxt}`;
                            toast.style.display = '';
                            setTimeout(()=>{ toast.style.display = 'none'; }, 2500);
                        }
                        const badgeCell = form.closest('tr')?.querySelector('td:nth-child(5)');
                        if (badgeCell){
                            if (hidden.value){
                                badgeCell.innerHTML = `<span class="badge badge-soft">${input.value}</span>`;
                            } else {
                                badgeCell.innerHTML = `<span class="badge">Unassigned</span>`;
                            }
                        }
                    } else {
                        const toast = document.getElementById('assign-error-toast');
                        const msg = document.getElementById('assign-error-toast-msg');
                        if (toast && msg){
                            msg.textContent = `Assign failed (status ${res.status}).`;
                            toast.style.display = '';
                            setTimeout(()=>{ toast.style.display = 'none'; }, 3000);
                        }
                        console.error('Assign failed', res.status);
                    }
                } catch(err){
                    const toast = document.getElementById('assign-error-toast');
                    const msg = document.getElementById('assign-error-toast-msg');
                    if (toast && msg){
                        msg.textContent = 'Assign error. Please try again.';
                        toast.style.display = '';
                        setTimeout(()=>{ toast.style.display = 'none'; }, 3000);
                    }
                    console.error('Assign error', err);
                } finally {
                    if (btn){ btn.disabled = false; btn.classList.remove('btn-disabled'); }
                }
            }
            document.querySelectorAll('form.ajax-assign').forEach(f => {
                f.addEventListener('submit', handleAssignSubmit);
            });
            // Live updates: connect SignalR and join workspace group
            const slug = '@Model.WorkspaceSlug';
            try {
                const connection = new signalR.HubConnectionBuilder()
                    .withUrl('/hubs/tickets')
                    .withAutomaticReconnect()
                    .build();
                connection.on('ticketCreated', function(t){
                    // Prepend a new row for the created ticket
                    const tbody = document.querySelector('table tbody');
                    if (!tbody) return;
                    const contactDisplay = t.contactDisplay || (t.contactId ?? '—');
                    const created = new Date(t.createdAt).toLocaleString();
                                        const tr = document.createElement('tr');
                                        tr.classList.add('fade-in');
                    const rowQs = `Query=@Model.Query&Status=@Model.Status&Priority=@Model.Priority&ContactId=@Model.ContactId&Mine=@Model.Mine&AssigneeUserId=@Model.AssigneeUserId&PageNumber=@Model.PageNumber&PageSize=@Model.PageSize`;
                                        const color = statusColors[t.status] || 'neutral';
                                        const isHex = (typeof color === 'string') && color.startsWith('#');
                                        const statusSpan = isHex
                                                ? `<span class="badge" style="background-color: ${color}; color: #fff;">${t.status}</span>`
                                                : `<span class="badge badge-soft badge-${color}">${t.status}</span>`;
                    tr.innerHTML = `
                        <td><a class="link link-hover" href="/workspaces/${slug}/tickets/${t.id}?${rowQs}">${t.subject}</a></td>
                        {
                            const pc = priorityColors[t.priority] || 'neutral';
                            const pIsHex = (typeof pc === 'string') && pc.startsWith('#');
                            const prioSpan = pIsHex
                                ? `<span class="badge badge-soft" style="background-color: ${pc}; color: #fff;">${t.priority}</span>`
                                : `<span class="badge badge-soft badge-${pc}">${t.priority}</span>`;
                            }
                        <td>${prioSpan}</td>
                                                <td>${statusSpan}</td>
                        <td><span>${contactDisplay}</span></td>
                        <td class="hidden sm:table-cell"><span class="badge ${t.assignedUserId ? 'badge-soft' : ''}">${t.assignedUserId ? (t.assignedDisplay || 'Assigned') : 'Unassigned'}</span></td>
                        <td>${t.inventoryRef ? `<a class="link link-hover" href="/workspaces/${slug}/inventory?Query=${t.inventoryRef}">${t.inventoryRef}</a>` : '<span class="opacity-50">—</span>'}</td>
                        <td class="hidden md:table-cell">${created}</td>
                        <td>
                          <div class="flex flex-wrap gap-2 items-center">
                            <a class="btn btn-soft btn-sm" href="/workspaces/${slug}/tickets/new?contactId=${t.contactId}">Clone</a>
                            <!-- Inline assign form omitted for live-created rows; user can open details page -->
                          </div>
                        </td>`;
                    tbody.insertBefore(tr, tbody.firstChild);
                });
                // Update existing row when a ticket is edited
                connection.on('ticketUpdated', function(t){
                    const row = document.querySelector(`tr td a[href^="/workspaces/${slug}/tickets/${t.id}"]`)?.closest('tr');
                    if (row){
                        const subjectCell = row.querySelector('td:nth-child(1) a');
                        const prioCell = row.querySelector('td:nth-child(2) .badge');
                        const statusCell = row.querySelector('td:nth-child(3) .badge');
                        if (subjectCell) subjectCell.textContent = t.subject;
                        if (prioCell) {
                            prioCell.textContent = t.priority;
                            const pc = priorityColors[t.priority] || 'neutral';
                            if ((typeof pc === 'string') && pc.startsWith('#')){
                                prioCell.className = 'badge badge-soft';
                                prioCell.setAttribute('style', `background-color: ${pc}; color: #fff;`);
                            } else {
                                prioCell.className = `badge badge-soft badge-${pc}`;
                                prioCell.removeAttribute('style');
                            }
                        }
                        if (statusCell) {
                            statusCell.textContent = t.status;
                            const c = statusColors[t.status] || 'neutral';
                            if ((typeof c === 'string') && c.startsWith('#')) {
                                statusCell.className = 'badge';
                                statusCell.setAttribute('style', `background-color: ${c}; color: #fff;`);
                            } else {
                                statusCell.className = `badge badge-soft badge-${c}`;
                                statusCell.removeAttribute('style');
                            }
                        }
                        const invCell = row.querySelector('td:nth-child(6)');
                        if (invCell){
                            if (t.inventoryRef){
                                invCell.innerHTML = `<a class="link link-hover" href="/workspaces/${slug}/inventory?Query=${t.inventoryRef}">${t.inventoryRef}</a>`;
                            } else {
                                invCell.innerHTML = '<span class="opacity-50">—</span>';
                            }
                        }
                    }
                });
                connection.on('ticketAssigned', function(t){
                    const row = document.querySelector(`tr td a[href^="/workspaces/${slug}/tickets/${t.id}"]`)?.closest('tr');
                    if (!row) return;
                    const assigneeCell = row.querySelector('td:nth-child(5)');
                    if (!assigneeCell) return;
                    if (t.assignedUserId){
                        const label = t.assignedDisplay || 'Assigned';
                        assigneeCell.innerHTML = `<span class="badge badge-soft">${label}</span>`;
                    } else {
                        assigneeCell.innerHTML = `<span class="badge">Unassigned</span>`;
                    }
                });
                await connection.start();
                await connection.invoke('JoinWorkspace', slug);
            } catch (err) {
                console.warn('SignalR connection failed', err);
            }
        })();
    </script>

    <div class="flex justify-between items-center">
        <div class="text-sm opacity-70">Showing page @Model.PageNumber of @((Model.Total + Model.PageSize - 1)/Model.PageSize) · @Model.Total total</div>
        <div class="join">
            @{
                var prev = Model.PageNumber > 1 ? Model.PageNumber - 1 : 1;
                var next = (Model.PageNumber * Model.PageSize) < Model.Total ? Model.PageNumber + 1 : Model.PageNumber;
                var baseQs = $"Query={Model.Query}&Status={Model.Status}&Priority={Model.Priority}&ContactId={Model.ContactId}&Mine={Model.Mine}&AssigneeUserId={Model.AssigneeUserId}&PageSize={Model.PageSize}";
            }
            <a class="btn btn-soft join-item btn-sm @(Model.PageNumber <= 1 ? "btn-disabled" : "")" href="?@baseQs&PageNumber=@prev">Prev</a>
            <a class="btn btn-soft join-item btn-sm @(((Model.PageNumber * Model.PageSize) >= Model.Total) ? "btn-disabled" : "")" href="?@baseQs&PageNumber=@next">Next</a>
        </div>
    </div>
    </div>
    </section>
</div>
