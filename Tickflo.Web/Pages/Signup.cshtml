@page
@model SignupModel
@inject Tickflo.Core.Config.TickfloConfig Config
@{
    ViewData["Title"] = "Sign Up";
}

<div class="flex min-h-[calc(100vh-6rem)] flex-col items-center justify-center">
    <div
        class="card w-full max-w-md bg-neutral-900/85 backdrop-blur shadow-2xl rounded-3xl border border-white/5 text-slate-100">
        <div class="card-body">
            <h2 class="card-title text-2xl font-bold mb-2">Sign Up</h2>
            <p class="text-sm text-slate-400 mb-6">Create your account to get started</p>
            <form method="post">
                <fieldset class="fieldset">
                    <label class="label" for="name">
                        <span class="label-text text-slate-300">Name</span>
                    </label>
                    <input id="name" asp-for="Name" type="text"
                        class="input validator bg-neutral-800/50 border-white/10 text-slate-100 focus:border-primary h-12 w-full"
                        placeholder="Your full name" />
                    <span asp-validation-for="Name" class="validator-hint"></span>

                    <label class="label" for="email">
                        <span class="label-text text-slate-300">Email</span>
                    </label>
                    <input id="email" asp-for="Email" type="email"
                        class="input validator bg-neutral-800/50 border-white/10 text-slate-100 focus:border-primary h-12 w-full"
                        placeholder="Email" oninput="checkRecoveryEmail()" />
                    <span asp-validation-for="Email" class="validator-hint"></span>

                    <label class="label" for="recoveryEmail">
                        <span class="label-text text-slate-300">Recovery Email</span>
                    </label>
                    <input id="recoveryEmail" asp-for="RecoveryEmail" type="email"
                        class="input validator bg-neutral-800/50 border-white/10 text-slate-100 focus:border-primary h-12 w-full"
                        placeholder="Recovery email" oninput="checkRecoveryEmail()" />
                    <div id="recoveryEmailWarning" style="display: none;">
                        @await Html.PartialAsync("_WarningAlert", Html.Raw("We <strong>strongly</strong> recommend using                a <strong>different</strong> email address in case your primary address is compromised."))
                    </div>
                    @if (!Model.Invited)
                    {
                        <span asp-validation-for="RecoveryEmail" class="validator-hint"></span>
                        <label class="label" for="workspaceName">
                            <span class="label-text text-slate-300">Workspace Name</span>
                        </label>
                        <em id="workspaceSlugPreview" title="Workspace URL Preview" style="display: none;"
                            class="text-xs text-slate-400"></em>
                        <input id="workspaceName" asp-for="WorkspaceName" type="text"
                            class="input validator bg-neutral-800/50 border-white/10 text-slate-100 focus:border-primary h-12 w-full"
                            placeholder="Your workspace name" oninput="updateWorkspaceSlug()" />
                        <span asp-validation-for="WorkspaceName" class="validator-hint"></span>
                    }
                    <label class="label" for="password">
                        <span class="label-text text-slate-300">Password</span>
                    </label>
                    <input id="password" asp-for="Password" type="password"
                        class="input validator bg-neutral-800/50 border-white/10 text-slate-100 focus:border-primary h-12 w-full"
                        placeholder="Password" />
                    <span asp-validation-for="Password" class="validator-hint"></span>

                    <label class="label" for="confirmPassword">
                        <span class="label-text text-slate-300">Confirm Password</span>
                    </label>
                    <input id="confirmPassword" asp-for="ConfirmPassword" type="password"
                        class="input validator bg-neutral-800/50 border-white/10 text-slate-100 focus:border-primary h-12 w-full"
                        placeholder="Confirm password" />
                    <span asp-validation-for="ConfirmPassword" class="validator-hint"></span>

                    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
                    {
                        @await Html.PartialAsync("_ErrorAlert", Html.Raw(Model.ErrorMessage))
                    }
                    <button type="submit" class="btn btn-primary mt-6 w-full rounded-full h-12">
                        Sign Up
                    </button>
                    <div class="text-center mt-4 text-slate-400">
                        Already have an account?
                        <a href="/login" class="link link-primary link-hover text-sm ml-1">
                            Login
                        </a>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const baseUrl = '@Html.Raw(System.Text.Encodings.Web.JavaScriptEncoder.Default.Encode(Config.BaseUrl))';

        function slugify(text) {
            return text
                .toLowerCase()
                .trim()
                .replace(/[^\w\s-]/g, '') // Remove special characters except spaces and hyphens
                .replace(/[\s_-]+/g, '-') // Replace spaces, underscores, and multiple hyphens with single hyphen
                .replace(/^-+|-+$/g, ''); // Remove leading and trailing hyphens
        }

        function updateWorkspaceSlug() {
            const workspaceNameInput = document.getElementById('workspaceName');
            const slugPreview = document.getElementById('workspaceSlugPreview');

            const workspaceName = workspaceNameInput.value;
            if (workspaceName.trim().length > 2) {
                const slug = slugify(workspaceName);
                slugPreview.style.display = 'block';
                if (slug) {
                    slugPreview.textContent = `${baseUrl}/${slug}`;
                } else {
                    slugPreview.textContent = 'Invalid workspace name - only letters, numbers, spaces, and hyphens allowed';
                    slugPreview.className = 'text-warning';
                }
            } else {
                slugPreview.textContent = '';
                slugPreview.style.display = 'none';
            }
        }

        function checkRecoveryEmail() {
            const emailInput = document.getElementById('email');
            const recoveryEmailInput = document.getElementById('recoveryEmail');
            const warningDiv = document.getElementById('recoveryEmailWarning');

            const email = emailInput.value.trim().toLowerCase();
            const recoveryEmail = recoveryEmailInput.value.trim().toLowerCase();

            if (email && recoveryEmail && email === recoveryEmail) {
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            updateWorkspaceSlug();
            checkRecoveryEmail();
        });
    </script>
}